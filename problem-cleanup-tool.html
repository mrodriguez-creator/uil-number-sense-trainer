<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UIL Problem Cleanup Tool</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background:#0f1419; color:#e2e8f0; }

.container { max-width: 1400px; margin: 0 auto; padding: 20px; }
.header { background:#1a1f2e; padding:20px; border-radius:12px; margin-bottom:20px; border:2px solid #667eea; }
.header h1 { color:#667eea; margin-bottom:10px; }
.stats { display:flex; gap:20px; margin-top:15px; }
.stat-box { background:#2d3748; padding:10px 20px; border-radius:8px; }
.stat-val { font-size:1.5rem; font-weight:700; color:#48bb78; }
.stat-label { font-size:0.85rem; color:#a0aec0; }

.main-grid { display:grid; grid-template-columns: 300px 1fr; gap:20px; }

/* Problem List */
.problem-list { background:#1a1f2e; border:2px solid #2d3748; border-radius:12px; padding:15px; max-height:calc(100vh - 200px); overflow-y:auto; }
.filter-section { margin-bottom:15px; }
.filter-section label { display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:5px; }
.filter-section select, .filter-section input { width:100%; padding:8px; background:#2d3748; border:1px solid #4a5568; border-radius:6px; color:#e2e8f0; font-size:0.9rem; }

.problem-item { background:#2d3748; padding:12px; margin-bottom:8px; border-radius:8px; cursor:pointer; border:2px solid transparent; transition:all 0.2s; }
.problem-item:hover { background:#4a5568; }
.problem-item.active { border-color:#667eea; background:#3d4556; }
.problem-item.cleaned { border-left:4px solid #48bb78; }
.problem-item.needs-work { border-left:4px solid #f56565; }
.pi-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; }
.pi-num { font-weight:700; color:#667eea; }
.pi-meta { font-size:0.75rem; color:#718096; }
.pi-preview { font-size:0.85rem; color:#a0aec0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pi-status { font-size:0.7rem; padding:2px 8px; border-radius:4px; }
.status-clean { background:#48bb78; color:#fff; }
.status-dirty { background:#f56565; color:#fff; }

/* Editor Panel */
.editor-panel { background:#1a1f2e; border:2px solid #2d3748; border-radius:12px; padding:20px; }
.editor-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.editor-title { color:#667eea; font-size:1.2rem; font-weight:700; }
.editor-actions { display:flex; gap:10px; }

.form-group { margin-bottom:20px; }
.form-group label { display:block; color:#a0aec0; font-size:0.9rem; margin-bottom:8px; font-weight:600; }
.form-group input, .form-group textarea, .form-group select { width:100%; padding:12px; background:#2d3748; border:2px solid #4a5568; border-radius:8px; color:#e2e8f0; font-size:1rem; font-family:monospace; }
.form-group textarea { min-height:100px; resize:vertical; }
.form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline:none; border-color:#667eea; }

.quick-replace { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
.quick-btn { background:#4a5568; color:#e2e8f0; border:none; padding:6px 12px; border-radius:6px; font-size:0.85rem; cursor:pointer; transition:all 0.2s; }
.quick-btn:hover { background:#667eea; }

.symbol-guide { background:#2d3748; padding:15px; border-radius:8px; margin-bottom:20px; }
.symbol-guide h3 { color:#667eea; font-size:0.95rem; margin-bottom:10px; }
.symbol-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:8px; }
.symbol-item { display:flex; justify-content:space-between; font-size:0.85rem; padding:4px 8px; background:#1a1f2e; border-radius:4px; }
.symbol-wrong { color:#f56565; }
.symbol-right { color:#48bb78; }

.btn { padding:10px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.2s; font-size:0.95rem; }
.btn-primary { background:#667eea; color:#fff; }
.btn-primary:hover { background:#5568d3; transform:translateY(-2px); }
.btn-secondary { background:#4a5568; color:#e2e8f0; }
.btn-secondary:hover { background:#5a6578; }
.btn-success { background:#48bb78; color:#fff; }
.btn-danger { background:#f56565; color:#fff; }

.save-indicator { padding:8px 16px; border-radius:6px; font-size:0.85rem; font-weight:600; }
.save-success { background:#48bb78; color:#fff; }
.save-error { background:#f56565; color:#fff; }

.empty-state { text-align:center; padding:60px 20px; }
.empty-state h2 { color:#667eea; margin-bottom:10px; }
.empty-state p { color:#a0aec0; }

.progress-bar { background:#2d3748; height:8px; border-radius:4px; overflow:hidden; margin-top:10px; }
.progress-fill { background:linear-gradient(90deg, #667eea, #48bb78); height:100%; transition:width 0.3s; }

::-webkit-scrollbar { width:8px; }
::-webkit-scrollbar-track { background:#1a1f2e; }
::-webkit-scrollbar-thumb { background:#4a5568; border-radius:4px; }
::-webkit-scrollbar-thumb:hover { background:#667eea; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üõ†Ô∏è UIL Problem Cleanup Tool</h1>
    <p>Fix garbled math symbols and add answers to extracted problems</p>
    <div class="stats">
      <div class="stat-box">
        <div class="stat-val" id="total-count">0</div>
        <div class="stat-label">Total Problems</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="cleaned-count">0</div>
        <div class="stat-label">Cleaned</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="remaining-count">0</div>
        <div class="stat-label">Remaining</div>
      </div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill" style="width:0%"></div>
    </div>
  </div>

  <div class="main-grid">
    <!-- Problem List -->
    <div class="problem-list">
      <div class="filter-section">
        <label>Filter by Year:</label>
        <select id="filter-year">
          <option value="">All Years</option>
        </select>
      </div>
      <div class="filter-section">
        <label>Filter by Test:</label>
        <select id="filter-test">
          <option value="">All Tests</option>
          <option value="A">Test A</option>
          <option value="B">Test B</option>
          <option value="D">Test D</option>
          <option value="R">Test R</option>
          <option value="S">Test S</option>
        </select>
      </div>
      <div class="filter-section">
        <label>Show:</label>
        <select id="filter-status">
          <option value="all">All Problems</option>
          <option value="dirty">Needs Cleanup</option>
          <option value="clean">Cleaned</option>
          <option value="starred">Starred Only</option>
        </select>
      </div>
      <div id="problem-list-items"></div>
    </div>

    <!-- Editor Panel -->
    <div class="editor-panel">
      <div id="editor-content"></div>
    </div>
  </div>
</div>

<script>
// Load problems from JSON
let allProblems = [];
let currentProblem = null;
let filteredProblems = [];

// Symbol replacement mapping
const SYMBOL_MAP = {
  '∆í': '√∑',
  '‚Äö': '√ó',
  '√à': '‚àö',
  '¬≥‚àö': '‚àõ',
  '¬∏': '|',
  '': '',
  '': '',
};

// Load cleaned problems
fetch('/mnt/user-data/outputs/cleaned_problems.json')
  .then(r => r.json())
  .then(data => {
    allProblems = data.map((p, i) => ({
      ...p,
      id: i,
      cleaned: false,
      answer: '',
      cleanedQuestion: p.q
    }));
    
    // Load any previously saved cleanup from localStorage
    const saved = localStorage.getItem('cleanupProgress');
    if(saved){
      const savedData = JSON.parse(saved);
      savedData.forEach(sp => {
        const problem = allProblems.find(p => p.id === sp.id);
        if(problem){
          problem.cleaned = sp.cleaned;
          problem.answer = sp.answer;
          problem.cleanedQuestion = sp.cleanedQuestion;
        }
      });
    }
    
    initializeUI();
  })
  .catch(err => {
    document.getElementById('editor-content').innerHTML = `
      <div class="empty-state">
        <h2>Error Loading Problems</h2>
        <p>${err.message}</p>
        <p>Make sure cleaned_problems.json is in /mnt/user-data/outputs/</p>
      </div>
    `;
  });

function initializeUI(){
  // Populate year filter
  const years = [...new Set(allProblems.map(p => p.year))].sort();
  const yearSelect = document.getElementById('filter-year');
  years.forEach(year => {
    const opt = document.createElement('option');
    opt.value = year;
    opt.textContent = year;
    yearSelect.appendChild(opt);
  });
  
  // Update stats
  updateStats();
  
  // Apply filters and render list
  applyFilters();
  
  // Select first problem
  if(filteredProblems.length > 0){
    selectProblem(filteredProblems[0]);
  } else {
    showEmptyEditor();
  }
  
  // Add event listeners
  document.getElementById('filter-year').onchange = applyFilters;
  document.getElementById('filter-test').onchange = applyFilters;
  document.getElementById('filter-status').onchange = applyFilters;
}

function updateStats(){
  const cleaned = allProblems.filter(p => p.cleaned).length;
  document.getElementById('total-count').textContent = allProblems.length;
  document.getElementById('cleaned-count').textContent = cleaned;
  document.getElementById('remaining-count').textContent = allProblems.length - cleaned;
  
  const progress = (cleaned / allProblems.length * 100).toFixed(1);
  document.getElementById('progress-fill').style.width = progress + '%';
}

function applyFilters(){
  const yearFilter = document.getElementById('filter-year').value;
  const testFilter = document.getElementById('filter-test').value;
  const statusFilter = document.getElementById('filter-status').value;
  
  filteredProblems = allProblems.filter(p => {
    if(yearFilter && p.year !== yearFilter) return false;
    if(testFilter && p.test !== testFilter) return false;
    if(statusFilter === 'dirty' && p.cleaned) return false;
    if(statusFilter === 'clean' && !p.cleaned) return false;
    if(statusFilter === 'starred' && !p.starred) return false;
    return true;
  });
  
  renderProblemList();
}

function renderProblemList(){
  const container = document.getElementById('problem-list-items');
  
  if(filteredProblems.length === 0){
    container.innerHTML = '<div style="color:#718096; text-align:center; padding:20px;">No problems match filters</div>';
    return;
  }
  
  container.innerHTML = filteredProblems.map(p => `
    <div class="problem-item ${p.cleaned ? 'cleaned' : 'needs-work'} ${currentProblem && currentProblem.id === p.id ? 'active' : ''}" 
         onclick="selectProblem(${p.id})">
      <div class="pi-header">
        <span class="pi-num">${p.starred ? '‚òÖ' : ''}#${p.num}</span>
        <span class="pi-meta">${p.year} ${p.test}</span>
        <span class="pi-status ${p.cleaned ? 'status-clean' : 'status-dirty'}">${p.cleaned ? '‚úì' : '‚úó'}</span>
      </div>
      <div class="pi-preview">${p.cleanedQuestion.substring(0, 60)}...</div>
    </div>
  `).join('');
}

function selectProblem(idOrProblem){
  const problem = typeof idOrProblem === 'number' ? 
    allProblems.find(p => p.id === idOrProblem) : idOrProblem;
  
  if(!problem) return;
  
  currentProblem = problem;
  renderProblemList();
  renderEditor(problem);
}

function renderEditor(p){
  document.getElementById('editor-content').innerHTML = `
    <div class="editor-header">
      <div class="editor-title">
        ${p.starred ? '‚òÖ ' : ''}Problem #${p.num} 
        <span style="color:#718096; font-size:0.9rem;">(${p.year} Test ${p.test})</span>
      </div>
      <div class="editor-actions">
        <button class="btn btn-secondary" onclick="skipProblem()">Skip ‚Üí</button>
        <button class="btn btn-success" onclick="saveProblem()">Save & Next</button>
      </div>
    </div>
    
    <div class="symbol-guide">
      <h3>Common Symbol Replacements:</h3>
      <div class="symbol-grid">
        <div class="symbol-item"><span class="symbol-wrong">∆í</span> ‚Üí <span class="symbol-right">√∑</span></div>
        <div class="symbol-item"><span class="symbol-wrong">‚Äö</span> ‚Üí <span class="symbol-right">√ó</span></div>
        <div class="symbol-item"><span class="symbol-wrong">√à</span> ‚Üí <span class="symbol-right">‚àö</span></div>
        <div class="symbol-item"><span class="symbol-wrong">q</span> ‚Üí <span class="symbol-right">‚àí</span></div>
        <div class="symbol-item"><span class="symbol-wrong">¬∏</span> ‚Üí <span class="symbol-right">|</span></div>
      </div>
    </div>
    
    <div class="form-group">
      <label>Original Question (from OCR):</label>
      <textarea readonly style="background:#2d3748; color:#f56565;">${p.q}</textarea>
    </div>
    
    <div class="form-group">
      <label>Cleaned Question:</label>
      <textarea id="cleaned-question" placeholder="Fix symbols and format correctly...">${p.cleanedQuestion}</textarea>
      <div class="quick-replace">
        <button class="quick-btn" onclick="autoReplace()">üîÑ Auto-Replace Symbols</button>
        <button class="quick-btn" onclick="insertSymbol('√∑')">Insert √∑</button>
        <button class="quick-btn" onclick="insertSymbol('√ó')">Insert √ó</button>
        <button class="quick-btn" onclick="insertSymbol('‚àö')">Insert ‚àö</button>
        <button class="quick-btn" onclick="insertSymbol('¬≤')">Insert ¬≤</button>
        <button class="quick-btn" onclick="insertSymbol('¬≥')">Insert ¬≥</button>
      </div>
    </div>
    
    <div class="form-group">
      <label>Answer:</label>
      <input type="text" id="answer" placeholder="Enter the correct answer..." value="${p.answer}">
    </div>
    
    <div class="form-group">
      <label>Topic:</label>
      <select id="topic">
        <option value="add" ${p.t==='add'?'selected':''}>Addition</option>
        <option value="sub" ${p.t==='sub'?'selected':''}>Subtraction</option>
        <option value="mul" ${p.t==='mul'?'selected':''}>Multiplication</option>
        <option value="div" ${p.t==='div'?'selected':''}>Division</option>
        <option value="ops" ${p.t==='ops'?'selected':''}>Mixed Operations</option>
        <option value="sq" ${p.t==='sq'?'selected':''}>Squares/Roots</option>
        <option value="cube" ${p.t==='cube'?'selected':''}>Cubes</option>
        <option value="pct" ${p.t==='pct'?'selected':''}>Percentages</option>
        <option value="fracdec" ${p.t==='fracdec'?'selected':''}>Fractions/Decimals</option>
        <option value="lcm" ${p.t==='lcm'?'selected':''}>LCM</option>
        <option value="gcd" ${p.t==='gcd'?'selected':''}>GCD</option>
        <option value="rem" ${p.t==='rem'?'selected':''}>Remainders</option>
        <option value="roman" ${p.t==='roman'?'selected':''}>Roman Numerals</option>
        <option value="mean" ${p.t==='mean'?'selected':''}>Mean/Average</option>
        <option value="conv" ${p.t==='conv'?'selected':''}>Conversions</option>
        <option value="base" ${p.t==='base'?'selected':''}>Base Conversion</option>
        <option value="powers" ${p.t==='powers'?'selected':''}>Powers</option>
        <option value="starred" ${p.t==='starred'?'selected':''}>Starred (Approximation)</option>
        <option value="advanced" ${p.t==='advanced'?'selected':''}>Advanced</option>
      </select>
    </div>
    
    <div id="save-message"></div>
  `;
}

function showEmptyEditor(){
  document.getElementById('editor-content').innerHTML = `
    <div class="empty-state">
      <h2>No Problem Selected</h2>
      <p>Select a problem from the list to start cleaning</p>
    </div>
  `;
}

function autoReplace(){
  const textarea = document.getElementById('cleaned-question');
  let text = textarea.value;
  
  // Apply all symbol replacements
  Object.entries(SYMBOL_MAP).forEach(([wrong, right]) => {
    text = text.split(wrong).join(right);
  });
  
  // Clean up extra spaces
  text = text.replace(/\s+/g, ' ').trim();
  
  textarea.value = text;
}

function insertSymbol(symbol){
  const textarea = document.getElementById('cleaned-question');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  
  textarea.value = text.substring(0, start) + symbol + text.substring(end);
  textarea.focus();
  textarea.setSelectionRange(start + symbol.length, start + symbol.length);
}

function saveProblem(){
  const cleanedQuestion = document.getElementById('cleaned-question').value.trim();
  const answer = document.getElementById('answer').value.trim();
  const topic = document.getElementById('topic').value;
  
  if(!cleanedQuestion){
    showMessage('Please enter a cleaned question', 'error');
    return;
  }
  
  // Update current problem
  currentProblem.cleanedQuestion = cleanedQuestion;
  currentProblem.answer = answer;
  currentProblem.t = topic;
  currentProblem.cleaned = true;
  
  // Save to localStorage
  saveProgress();
  
  // Update UI
  updateStats();
  showMessage('Saved!', 'success');
  
  // Move to next problem
  setTimeout(() => {
    const currentIndex = filteredProblems.findIndex(p => p.id === currentProblem.id);
    if(currentIndex < filteredProblems.length - 1){
      selectProblem(filteredProblems[currentIndex + 1]);
    } else {
      showMessage('All filtered problems completed!', 'success');
    }
  }, 500);
}

function skipProblem(){
  const currentIndex = filteredProblems.findIndex(p => p.id === currentProblem.id);
  if(currentIndex < filteredProblems.length - 1){
    selectProblem(filteredProblems[currentIndex + 1]);
  }
}

function saveProgress(){
  const progress = allProblems.map(p => ({
    id: p.id,
    cleaned: p.cleaned,
    cleanedQuestion: p.cleanedQuestion,
    answer: p.answer,
    t: p.t
  }));
  
  localStorage.setItem('cleanupProgress', JSON.stringify(progress));
  
  // Also save to a downloadable file periodically
  if(allProblems.filter(p => p.cleaned).length % 10 === 0){
    downloadProgress();
  }
}

function downloadProgress(){
  const cleanedProblems = allProblems.filter(p => p.cleaned).map(p => ({
    num: p.num,
    q: p.cleanedQuestion,
    a: p.answer,
    t: p.t,
    year: p.year,
    test: p.test,
    starred: p.starred,
    source: p.source
  }));
  
  const blob = new Blob([JSON.stringify(cleanedProblems, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `cleaned_problems_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
}

function showMessage(msg, type){
  const el = document.getElementById('save-message');
  el.className = type === 'success' ? 'save-indicator save-success' : 'save-indicator save-error';
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 2000);
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if(e.ctrlKey || e.metaKey){
    if(e.key === 's'){
      e.preventDefault();
      saveProblem();
    }
    if(e.key === 'ArrowRight'){
      e.preventDefault();
      skipProblem();
    }
  }
});
</script>

</body>
</html>
