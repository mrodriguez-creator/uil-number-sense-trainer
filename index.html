<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UIL Number Sense â€“ Problems 1â€“20 Trainer</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0f1419; color: #fff; min-height: 100vh; }

/* â”€â”€ HEADER â”€â”€ */
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 28px 20px; text-align: center; }
.header h1 { font-size: 2.1rem; margin-bottom: 4px; }
.header p { color: #ddd; font-size: 0.95rem; }

/* â”€â”€ MENU LAYOUT â”€â”€ */
.menu-body { max-width: 920px; margin: 0 auto; padding: 24px 20px 40px; }
.section-tag { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.6px; color: #667eea; font-weight: 700; margin-bottom: 10px; margin-top: 30px; }
.section-tag:first-child { margin-top: 0; }

/* Focus card */
.focus-card { background: linear-gradient(140deg, #1c2640 0%, #1a1f2e 100%); border: 2px solid #667eea; border-radius: 16px; padding: 26px; }
.fc-head { display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap; margin-bottom: 20px; }
.fc-icon { font-size: 2.4rem; flex-shrink: 0; }
.fc-head h2 { font-size: 1.4rem; margin-bottom: 4px; }
.fc-head p { color: #a0aec0; font-size: 0.85rem; line-height: 1.5; max-width: 540px; }
.mode-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
.mode-btn { background: #2d3748; border: 2px solid #4a5568; border-radius: 10px; padding: 18px 16px; cursor: pointer; color: #fff; text-align: left; transition: border-color .15s, background .15s; }
.mode-btn:hover { border-color: #667eea; background: #363e52; }
.mode-btn .mb-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 3px; }
.mode-btn .mb-desc { color: #a0aec0; font-size: 0.76rem; line-height: 1.4; }

/* Topic grid */
.topic-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
.topic-btn { background: #1a1f2e; border: 1px solid #2d3748; border-radius: 9px; padding: 14px 8px; cursor: pointer; color: #fff; text-align: center; transition: border-color .15s, background .15s; }
.topic-btn:hover { border-color: #667eea; background: #222838; }
.topic-btn .tb-icon { font-size: 1.5rem; margin-bottom: 4px; }
.topic-btn .tb-name { font-weight: 600; font-size: 0.78rem; }
.topic-btn .tb-sub { color: #667eea; font-size: 0.66rem; margin-top: 2px; }

/* Secondary buttons */
.sec-row { display: flex; gap: 10px; flex-wrap: wrap; }
.sec-btn { flex: 1; min-width: 180px; background: #1a1f2e; border: 1px solid #2d3748; border-radius: 10px; padding: 16px; cursor: pointer; color: #fff; transition: border-color .15s; }
.sec-btn:hover { border-color: #667eea; }
.sec-btn .sb-title { font-weight: 600; font-size: 0.9rem; }
.sec-btn .sb-desc { color: #a0aec0; font-size: 0.74rem; margin-top: 2px; }

/* â”€â”€ TEST SCREEN â”€â”€ */
.test-header { background: #1a1f2e; padding: 14px 20px; border-bottom: 2px solid #2d3748; }
.test-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px; font-size: 0.92rem; margin-bottom: 8px; }
.test-top .t-label { color: #667eea; font-weight: 700; }
.test-top .t-timer { font-weight: 700; }
.test-top .t-timer.ok { color: #48bb78; }
.test-top .t-timer.warn { color: #ed8936; }
.test-top .t-timer.urgent { color: #f56565; }
.test-top .t-timer.none { color: #718096; }
.test-top .t-score { color: #a0aec0; }
.prog-bar { width: 100%; height: 5px; background: #2d3748; border-radius: 3px; overflow: hidden; }
.prog-fill { height: 100%; background: #667eea; transition: width .25s; }

.test-body { max-width: 680px; margin: 32px auto; padding: 0 20px; }

/* Feedback bar (drill modes) */
.feedback-bar { min-height: 28px; display: flex; align-items: center; justify-content: center; font-size: 0.88rem; font-weight: 600; margin-bottom: 8px; border-radius: 6px; transition: background .15s; padding: 6px 12px; text-align: center; line-height: 1.4; }
.feedback-bar.correct { background: #2f5349; color: #68d391; }
.feedback-bar.wrong { background: #5a2d2d; color: #fc8181; }
.feedback-bar.wrong .hint-tag { color: #f6ad55; font-weight: 400; }
.feedback-bar.empty { background: transparent; }

.problem-box { background: #1a1f2e; border: 3px solid #667eea; border-radius: 14px; padding: 42px 20px; text-align: center; margin-bottom: 20px; }
.problem-text { font-size: 2.3rem; font-weight: 700; word-break: break-word; line-height: 1.3; }
.problem-tag { margin-top: 8px; font-size: 0.68rem; color: #4a5568; text-transform: uppercase; letter-spacing: 0.8px; }

input.ans-box {
  width: 100%; padding: 16px; font-size: 1.8rem; text-align: center;
  background: #2d3748; color: #fff; border: 2px solid #4a5568; border-radius: 8px;
  margin-bottom: 16px; font-weight: 600; outline: none;
}
input.ans-box:focus { border-color: #667eea; }

.btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
.btn-row .btn { flex: 1; margin-bottom: 0; }

.btn { display: block; width: 100%; padding: 14px; font-size: 1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; color: #fff; transition: filter .15s; }
.btn:hover { filter: brightness(1.15); }
.btn-primary { background: #667eea; }
.btn-green { background: #38a169; }
.btn-orange { background: #ed8936; }
.btn-subtle { background: #2d3748; color: #718096; border: 1px solid #4a5568; font-size: 0.82rem; padding: 10px; }

/* Fraction slash helper */
.frac-helper { margin-bottom: 10px; }
.frac-btn { display: block; width: 100%; padding: 10px; background: #2d3748; border: 1px solid #4a5568; border-radius: 8px; color: #667eea; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background .15s, border-color .15s; }
.frac-btn:hover, .frac-btn:active { background: #363e52; border-color: #667eea; }

/* Streak badge */
.streak { display: inline-block; background: #ed8936; color: #fff; border-radius: 12px; padding: 2px 8px; font-size: 0.72rem; font-weight: 700; margin-left: 6px; }

/* â”€â”€ RESULTS â”€â”€ */
.results-wrap { max-width: 800px; margin: 32px auto; padding: 0 20px; }
.results-wrap h1 { text-align: center; font-size: 2rem; color: #667eea; margin-bottom: 22px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 28px; }
.stat-card { background: #1a1f2e; border: 2px solid #2d3748; border-radius: 12px; padding: 18px 10px; text-align: center; }
.stat-val { font-size: 2rem; font-weight: 700; color: #667eea; }
.stat-label { color: #a0aec0; font-size: 0.82rem; margin-top: 2px; }
.review-title { font-size: 1.1rem; margin-bottom: 8px; color: #e2e8f0; }
.review-box { background: #1a1f2e; border-radius: 10px; padding: 10px; max-height: 360px; overflow-y: auto; }
.rev-item { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 4px; padding: 8px 10px; border-radius: 6px; font-size: 0.82rem; margin-bottom: 4px; }
.rev-item.correct { background: #2f5349; }
.rev-item.wrong { background: #5a2d2d; }
.rev-item .ri-num { font-weight: 700; min-width: 28px; color: #667eea; flex-shrink: 0; }
.rev-item .ri-q { flex: 1; min-width: 120px; }
.rev-item .ri-a { font-weight: 600; min-width: 120px; text-align: right; }
.rev-item.correct .ri-a { color: #68d391; }
.rev-item.wrong .ri-a { color: #fc8181; }
.res-btns { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
.res-btns .btn { flex: 1; min-width: 140px; }

/* â”€â”€ TIME PICKER MODAL â”€â”€ */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:100; padding:20px; }
.modal-box { background:#1a1f2e; border:2px solid #2d3748; border-radius:16px; padding:30px; max-width:420px; width:100%; }
.modal-box h2 { font-size:1.3rem; margin-bottom:6px; }
.modal-box .modal-sub { color:#a0aec0; font-size:0.82rem; margin-bottom:20px; }
.time-btn { display:block; width:100%; background:#2d3748; border:2px solid #4a5568; color:#fff; border-radius:10px; padding:15px 18px; margin-bottom:8px; cursor:pointer; text-align:left; font-size:0.92rem; transition:border-color .15s, background .15s; }
.time-btn:hover { border-color:#667eea; background:#363e52; }
.time-btn .tb-row { display:flex; justify-content:space-between; align-items:center; }
.time-btn .tb-time { font-weight:700; color:#667eea; font-size:1.05rem; }
.time-btn .tb-note { color:#a0aec0; font-size:0.72rem; }
.modal-close { display:block; width:100%; background:none; border:none; color:#718096; cursor:pointer; font-size:0.8rem; margin-top:8px; padding:6px; }
.modal-close:hover { color:#fff; }

/* Quick Reference FAB */
.ref-fab { position:fixed; bottom:20px; right:20px; width:56px; height:56px; border-radius:50%; background:#667eea; color:#fff; border:none; font-size:1.3rem; cursor:pointer; box-shadow:0 4px 12px rgba(102,126,234,0.4); z-index:50; transition:transform .2s; }
.ref-fab:hover { transform:scale(1.1); }
.ref-fab:active { transform:scale(0.95); }

/* Reference Sheet Modal */
.ref-modal { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:flex-start; justify-content:center; z-index:100; padding:20px; overflow-y:auto; }
.ref-modal.show { display:flex; }
.ref-content { background:#1a1f2e; border:2px solid #667eea; border-radius:16px; padding:30px; max-width:800px; width:100%; margin:40px 0; }
.ref-content h2 { color:#667eea; margin-bottom:20px; font-size:1.6rem; }
.ref-content h3 { color:#e2e8f0; margin:20px 0 10px; font-size:1.1rem; }
.ref-content ul { color:#a0aec0; line-height:1.8; margin-left:20px; }
.ref-content code { background:#2d3748; padding:2px 6px; border-radius:4px; color:#667eea; font-family:monospace; }
.ref-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px; margin-top:15px; }
.ref-card { background:#2d3748; padding:15px; border-radius:10px; }
.ref-card h4 { color:#667eea; font-size:0.9rem; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px; }
.ref-card p { color:#a0aec0; font-size:0.85rem; line-height:1.6; }
.ref-close { display:block; width:100%; background:#667eea; color:#fff; border:none; padding:12px; border-radius:8px; font-weight:600; cursor:pointer; margin-top:20px; }
.ref-close:hover { filter:brightness(1.1); }

/* PROGRESS TRACKING STATS SCREEN */
.stats-preview { display:flex; gap:15px; margin:15px 0; flex-wrap:wrap; justify-content:center; }
.sp-item { background:#2d3748; padding:8px 16px; border-radius:8px; font-size:0.85rem; color:#a0aec0; }
.stats-btn { background:#667eea; color:#fff; border:none; padding:12px 24px; border-radius:10px; font-weight:600; font-size:0.95rem; cursor:pointer; margin-top:10px; transition:all 0.2s; }
.stats-btn:hover { background:#5568d3; transform:translateY(-2px); }
.stats-screen { min-height:100vh; background:#0f1419; padding:0; }
.stats-screen .header { background:#1a1f2e; padding:20px; border-bottom:2px solid #667eea; position:relative; }
.stats-screen .header h1 { color:#e2e8f0; margin:0; }
.back-btn { position:absolute; top:20px; right:20px; background:#2d3748; color:#a0aec0; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9rem; }
.back-btn:hover { background:#4a5568; color:#e2e8f0; }
.stats-body { padding:20px; max-width:1200px; margin:0 auto; }
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:20px; }
.stat-card.big { padding:20px; background:#1a1f2e; border:2px solid #2d3748; border-radius:12px; text-align:center; position:relative; }
.stat-val { color:#667eea; font-size:2.5rem; font-weight:700; margin-bottom:5px; }
.stat-label { color:#a0aec0; font-size:0.85rem; text-transform:uppercase; letter-spacing:0.5px; }
.stat-sub { color:#718096; font-size:0.75rem; margin-top:5px; }
.stat-badge { position:absolute; top:10px; right:10px; padding:4px 10px; border-radius:20px; font-size:0.7rem; font-weight:600; }
.stat-badge.positive { background:#48bb78; color:#fff; }
.stat-badge.negative { background:#f56565; color:#fff; }
.empty-stats { text-align:center; padding:80px 20px; }
.es-icon { font-size:5rem; margin-bottom:20px; }
.empty-stats h2 { color:#e2e8f0; margin-bottom:10px; }
.empty-stats p { color:#a0aec0; margin-bottom:30px; }

/* Performance Graph */
.graph-container { background:#1a1f2e; border:2px solid #2d3748; border-radius:12px; padding:20px; display:flex; align-items:flex-end; justify-content:space-around; height:200px; gap:10px; }
.graph-bar { flex:1; display:flex; flex-direction:column; align-items:center; gap:5px; }
.gb-bar-container { width:100%; height:140px; background:#2d3748; border-radius:8px 8px 0 0; position:relative; display:flex; align-items:flex-end; }
.gb-bar { width:100%; background:linear-gradient(to top,#667eea,#48bb78); border-radius:8px 8px 0 0; transition:height 0.3s; min-height:5px; }
.gb-label { color:#a0aec0; font-size:0.7rem; }
.gb-mode { color:#718096; font-size:0.65rem; }

/* Topic Stats */
.topic-stats { background:#1a1f2e; border:2px solid #2d3748; border-radius:12px; padding:20px; }
.topic-stat { display:grid; grid-template-columns:120px 1fr 100px; gap:15px; align-items:center; padding:12px 0; border-bottom:1px solid #2d3748; }
.topic-stat:last-child { border-bottom:none; }
.ts-name { color:#e2e8f0; font-weight:600; font-size:0.9rem; }
.ts-bar-container { background:#2d3748; height:20px; border-radius:10px; overflow:hidden; }
.ts-bar { height:100%; border-radius:10px; transition:width 0.3s; }
.ts-score { color:#a0aec0; font-size:0.85rem; text-align:right; }

/* History Table */
.history-table { background:#1a1f2e; border:2px solid #2d3748; border-radius:12px; padding:20px; overflow-x:auto; }
.history-table table { width:100%; border-collapse:collapse; }
.history-table th { color:#667eea; text-align:left; padding:10px; border-bottom:2px solid #2d3748; font-size:0.85rem; text-transform:uppercase; letter-spacing:0.5px; }
.history-table td { color:#a0aec0; padding:10px; border-bottom:1px solid #2d3748; font-size:0.9rem; }
.history-table tr:last-child td { border-bottom:none; }
.history-table tr:hover { background:#2d3748; }
</style>
</head>
<body>
<div id="app"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS TRACKING SYSTEM (LocalStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function loadStats(){
  try{
    let raw = localStorage.getItem('uilNsStats');
    return raw ? JSON.parse(raw) : {sessions:[], topicStats:{}, firstUse:new Date().toISOString()};
  }catch(e){
    console.error('Failed to load stats:', e);
    return {sessions:[], topicStats:{}, firstUse:new Date().toISOString()};
  }
}

function saveStats(stats){
  try{
    localStorage.setItem('uilNsStats', JSON.stringify(stats));
    return true;
  }catch(e){
    console.error('Failed to save stats:', e);
    return false;
  }
}

function recordSession(sessionData){
  let stats = loadStats();
  
  // Add new session
  let session = {
    date: new Date().toISOString(),
    mode: sessionData.mode,
    score: sessionData.score,
    total: sessionData.total,
    timeUsed: sessionData.timeUsed || 0,
    secondsPerProblem: sessionData.timeUsed && sessionData.total > 0 ? Math.round(sessionData.timeUsed / sessionData.total * 10) / 10 : null,
    topics: sessionData.topicBreakdown || {}
  };
  
  stats.sessions.push(session);
  
  // Keep last 200 sessions only
  if(stats.sessions.length > 200){
    stats.sessions = stats.sessions.slice(-200);
  }
  
  // Update per-topic cumulative stats
  Object.entries(session.topics).forEach(([topic, data]) => {
    if(!stats.topicStats[topic]){
      stats.topicStats[topic] = {correct:0, total:0, lastPracticed:session.date};
    }
    stats.topicStats[topic].correct += data.correct || 0;
    stats.topicStats[topic].total += data.total || 0;
    stats.topicStats[topic].lastPracticed = session.date;
  });
  
  saveStats(stats);
  return stats;
}

function getTopicBreakdown(answered){
  let breakdown = {};
  answered.forEach(item => {
    let topic = item.t || 'unknown';
    if(!breakdown[topic]) breakdown[topic] = {correct:0, total:0};
    breakdown[topic].total++;
    if(item.correct) breakdown[topic].correct++;
  });
  return breakdown;
}

function getStats(){
  let stats = loadStats();
  
  // Calculate derived stats
  let totalSessions = stats.sessions.length;
  let totalProblems = stats.sessions.reduce((sum, s) => sum + s.total, 0);
  let totalCorrect = stats.sessions.reduce((sum, s) => sum + s.score, 0);
  let overallAccuracy = totalProblems > 0 ? Math.round(totalCorrect / totalProblems * 100) : 0;
  
  // Recent performance (last 10 sessions)
  let recent = stats.sessions.slice(-10);
  let recentAccuracy = recent.length > 0 ? 
    Math.round(recent.reduce((sum, s) => sum + s.score, 0) / recent.reduce((sum, s) => sum + s.total, 0) * 100) : 0;
  
  // Personal bests
  let bestScore = stats.sessions.reduce((best, s) => {
    if(s.mode === 'timed20' && s.total === 20){
      return s.score > best.score ? s : best;
    }
    return best;
  }, {score:0, date:null});
  
  let bestFullTest = stats.sessions.reduce((best, s) => {
    if(s.mode === 'full' && s.total === 80){
      return s.score > best.score ? s : best;
    }
    return best;
  }, {score:0, date:null});
  
  // Streak calculation (days with at least 1 session)
  let streak = 0;
  if(stats.sessions.length > 0){
    let today = new Date();
    today.setHours(0,0,0,0);
    let sessionDates = [...new Set(stats.sessions.map(s => {
      let d = new Date(s.date);
      d.setHours(0,0,0,0);
      return d.getTime();
    }))].sort((a,b) => b-a);
    
    for(let i=0; i<sessionDates.length; i++){
      let expectedDate = new Date(today.getTime() - i * 86400000);
      if(sessionDates[i] === expectedDate.getTime()){
        streak++;
      } else {
        break;
      }
    }
  }
  
  // Speed improvement (compare first 10 sessions to last 10)
  let timedSessions = stats.sessions.filter(s => s.secondsPerProblem !== null);
  let speedImprovement = null;
  if(timedSessions.length >= 20){
    let firstAvg = timedSessions.slice(0,10).reduce((sum,s) => sum + s.secondsPerProblem, 0) / 10;
    let lastAvg = timedSessions.slice(-10).reduce((sum,s) => sum + s.secondsPerProblem, 0) / 10;
    speedImprovement = Math.round((firstAvg - lastAvg) * 10) / 10;
  }
  
  return {
    totalSessions,
    totalProblems,
    totalCorrect,
    overallAccuracy,
    recentAccuracy,
    bestScore,
    bestFullTest,
    streak,
    speedImprovement,
    topicStats: stats.topicStats,
    recentSessions: stats.sessions.slice(-20).reverse(),
    firstUse: stats.firstUse
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REAL PROBLEMS FROM UIL TESTS 2020-2022 (Problems 1-20 range)
// Each has a .t (type) tag for topic filtering
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REAL_BASIC = [
  // Addition
  {q:"2050 + 202 =",a:2252,t:"add"},{q:"417 + 1820 =",a:2237,t:"add"},
  {q:"5080 + 911 =",a:5991,t:"add"},{q:"322 + 2126 =",a:2448,t:"add"},
  {q:"6528 + 949 =",a:7477,t:"add"},{q:"3394 + 902 =",a:4296,t:"add"},
  {q:"20720 + 31420 =",a:52140,t:"add"},
  // Subtraction
  {q:"6834 âˆ’ 17 =",a:6817,t:"sub"},{q:"41720 âˆ’ 18420 =",a:23300,t:"sub"},
  {q:"1141 âˆ’ 393 =",a:748,t:"sub"},{q:"34194 âˆ’ 8542 =",a:25652,t:"sub"},
  {q:"31420 âˆ’ 20720 =",a:10700,t:"sub"},{q:"2328 âˆ’ 232 =",a:2096,t:"sub"},
  {q:"5622 âˆ’ 1247 + 525 =",a:4900,t:"sub"},
  // Multiplication
  {q:"122 Ã— 5 =",a:610,t:"mul"},{q:"33 Ã— 27 =",a:891,t:"mul"},
  {q:"14 Ã— 31 =",a:434,t:"mul"},{q:"17 Ã— 71 =",a:1207,t:"mul"},
  {q:"13 Ã— 24 =",a:312,t:"mul"},{q:"46 Ã— 34 =",a:1564,t:"mul"},
  {q:"2.5 Ã— 1.6 =",a:4,t:"mul"},{q:"58 Ã— 62 =",a:3596,t:"mul"},
  {q:"4.8 Ã— 1.5 =",a:7.2,t:"mul"},{q:"72 Ã— 88 =",a:6336,t:"mul"},
  {q:"73 Ã— 33 =",a:2409,t:"mul"},{q:"18 Ã— 81 =",a:1458,t:"mul"},
  {q:"14 Ã— 312 =",a:4368,t:"mul"},{q:"37 Ã— 15 =",a:555,t:"mul"},
  {q:"73 Ã— 87 =",a:6351,t:"mul"},
  // Division (exact)
  {q:"20520 Ã· 5 =",a:4104,t:"div"},{q:"4692 Ã· 23 =",a:204,t:"div"},
  {q:"3672 Ã· 12 =",a:306,t:"div"},{q:"1957 Ã· 19 =",a:103,t:"div"},
  {q:"26052 Ã· 13 =",a:2004,t:"div"},
  // Squares
  {q:"58Â² =",a:3364,t:"sq"},{q:"42Â² =",a:1764,t:"sq"},{q:"23Â² =",a:529,t:"sq"},
  {q:"43Â² =",a:1849,t:"sq"},{q:"54Â² =",a:2916,t:"sq"},{q:"47Â² =",a:2209,t:"sq"},
  {q:"16Â² =",a:256,t:"sq"},{q:"48Â² =",a:2304,t:"sq"},{q:"49Â² =",a:2401,t:"sq"},
  {q:"31Â² =",a:961,t:"sq"},{q:"28Â² =",a:784,t:"sq"},{q:"44Â² âˆ’ 42Â² =",a:172,t:"sq"},
  // Cubes
  {q:"12Â³ =",a:1728,t:"cube"},{q:"15Â³ =",a:3375,t:"cube"},
  // Remainders
  {q:"50220 Ã· 9 remainder?",a:0,t:"rem"},{q:"2020 Ã· 6 remainder?",a:4,t:"rem"},
  {q:"107205 Ã· 6 remainder?",a:3,t:"rem"},{q:"41718 Ã· 6 remainder?",a:0,t:"rem"},
  {q:"2126 Ã· 4 remainder?",a:2,t:"rem"},{q:"50622 Ã· 9 remainder?",a:6,t:"rem"},
  {q:"110220 Ã· 3 remainder?",a:0,t:"rem"},{q:"2328 Ã· 9 remainder?",a:6,t:"rem"},
  {q:"2328 Ã· 6 remainder?",a:0,t:"rem"},
  // LCM / GCD
  {q:"The LCM of 52 and 24 =",a:312,t:"lcm"},{q:"LCM(15, 21, 30) =",a:210,t:"lcm"},
  {q:"The LCM of 78 and 24 =",a:312,t:"lcm"},{q:"The LCM of 24 and 42 =",a:168,t:"lcm"},
  // Percentages
  {q:"24 is what % of 20?",a:120,t:"pct"},{q:"170 less 30% of 170 =",a:119,t:"pct"},
  {q:"48 is x% of 160. Find x.",a:30,t:"pct"},{q:"3/16 = ?%",a:18.75,t:"pct"},
  {q:"17 is what % of 85?",a:20,t:"pct"},{q:"24 is what % of 60?",a:40,t:"pct"},
  {q:"21 is what % of 105?",a:20,t:"pct"},{q:"140 less 14% of 140 =",a:120.4,t:"pct"},
  // Conversions
  {q:"3 gallons = ? pints",a:24,t:"conv"},
  // Mean
  {q:"The arithmetic mean of 41, 46, 57 =",a:48,t:"mean"},
  // Roman numerals (added for coverage)
  {q:"MMXXI =",a:2021,t:"roman"},{q:"MDCLXVI =",a:1666,t:"roman"},
  {q:"MCMXCIX =",a:1999,t:"roman"},{q:"MMXX =",a:2020,t:"roman"},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GENERATORS â€“ one per skill type, matching real UIL Problems 1-20
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gcd(a,b){return b?gcd(b,a%b):a;}
function lcmFn(a,b){return(a/gcd(a,b))*b;}
function shuffle(a){a=[...a];for(let i=a.length-1;i>0;i--){let j=ri(0,i);[a[i],a[j]]=[a[j],a[i]];}return a;}
function pick(a){return a[ri(0,a.length-1)];}
function ri(lo,hi){return Math.floor(Math.random()*(hi-lo+1))+lo;}

function toRoman(n){
  let v=[[1000,"M"],[900,"CM"],[500,"D"],[400,"CD"],[100,"C"],[90,"XC"],[50,"L"],[40,"XL"],[10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]];
  let r="";for(let[val,s]of v)while(n>=val){r+=s;n-=val;}return r;
}

const GEN = {
  add: ()=>{
    let a=ri(100,50000),b=ri(100,9999);
    return {q:`${a} + ${b} =`,a:a+b,t:"add"};
  },
  sub: ()=>{
    let a=ri(500,50000),b=ri(100,Math.min(a-1,9999));
    return {q:`${a} âˆ’ ${b} =`,a:a-b,t:"sub"};
  },
  mul: ()=>{
    // Mix of 2-digit Ã— 2-digit, 2-digit Ã— 3-digit, and single-digit Ã— larger
    let type=ri(0,2);
    if(type===0){ let a=ri(10,99),b=ri(10,99); return {q:`${a} Ã— ${b} =`,a:a*b,t:"mul"}; }
    if(type===1){ let a=ri(10,99),b=ri(100,999); return {q:`${a} Ã— ${b} =`,a:a*b,t:"mul"}; }
    let a=ri(2,9),b=ri(100,9999); return {q:`${a} Ã— ${b} =`,a:a*b,t:"mul"};
  },
  div: ()=>{
    let d=pick([3,4,5,6,7,8,9,11,12,13,15,17,19,23,25]);
    let q=ri(10,800); return {q:`${d*q} Ã· ${d} =`,a:q,t:"div"};
  },
  sq: ()=>{
    let a=ri(10,80); return {q:`${a}Â² =`,a:a*a,t:"sq"};
  },
  cube: ()=>{
    let a=ri(2,18); return {q:`${a}Â³ =`,a:a*a*a,t:"cube"};
  },
  rem: ()=>{
    let d=pick([3,4,6,9]);
    let n;
    if(d===4){
      // For Ã·4 the remainder only depends on the last two digits,
      // so use numbers big enough that students can't just divide mentally end-to-end.
      n=ri(1000,99999);
    } else {
      // For Ã·3, Ã·6, Ã·9 the casting-out-digits rule applies to ALL digits,
      // so bigger numbers are more useful practice.
      n=ri(10000,999999);
    }
    return {q:`${n} Ã· ${d} remainder?`,a:n%d,t:"rem"};
  },
  lcm: ()=>{
    let pairs=[[12,18],[8,12],[15,20],[24,36],[14,21],[9,15],[16,24],[6,10],[18,30],[20,28],
      [24,42],[52,24],[78,24],[15,21],[10,14],[8,6],[9,12],[16,12],[20,30],[36,48],
      [15,10],[42,30],[24,18],[28,42],[30,45],[12,16],[18,24],[36,60],[15,35],[20,24],
      [40,56],[21,28],[18,45],[24,40],[30,42]];
    let[a,b]=pick(pairs);
    return {q:`The LCM of ${a} and ${b} =`,a:lcmFn(a,b),t:"lcm"};
  },
  gcd: ()=>{
    let pairs=[[56,84],[12,40],[24,36],[18,48],[30,45],[42,70],[36,60],[24,60],
      [48,72],[20,50],[35,49],[54,81],[16,44],[28,42],[40,60],[32,48],
      [21,63],[15,45],[24,80],[36,54],[60,84],[45,75],[48,80],[66,88]];
    let[a,b]=pick(pairs);
    return {q:`The GCD of ${a} and ${b} =`,a:gcd(a,b),t:"gcd"};
  },
  pct: ()=>{
    let type=ri(0,3);
    if(type===0){
      // X% of Y  â†’  nice numbers
      let y=pick([20,25,40,50,60,80,100,120,150,200,250,300,400,500]);
      let x=pick([10,12,15,20,25,30,40,50,60,75,80]);
      return {q:`${x}% of ${y} =`,a:y*x/100,t:"pct"};
    }
    if(type===1){
      // A is what % of B?  â†’  ensure clean %
      let pcts=[10,12,15,20,25,30,40,50,60,75,80,100,120,150,200];
      let p=pick(pcts);
      let bases=[20,25,40,50,60,80,100,120,150,200,250,300,400,500];
      let b=pick(bases);
      let a=b*p/100;
      return {q:`${a} is what % of ${b}?`,a:p,t:"pct"};
    }
    if(type===2){
      // Y less X% of Y
      let y=pick([40,50,60,80,100,120,150,200,250,300,400,500]);
      let x=pick([10,15,20,25,30,40,50]);
      return {q:`${y} less ${x}% of ${y} =`,a:y*(1-x/100),t:"pct"};
    }
    // fraction â†’ %
    let fracs=[[1,2,50],[1,4,25],[3,4,75],[1,5,20],[2,5,40],[3,5,60],[4,5,80],
      [1,8,12.5],[3,8,37.5],[5,8,62.5],[7,8,87.5],[1,10,10],[3,10,30],[7,10,70],
      [1,16,6.25],[3,16,18.75],[5,16,31.25],[7,16,43.75],[1,20,5],[3,20,15],
      [1,25,4],[2,25,8],[3,25,12],[1,3,33.33]];
    let[n,d,p]=pick(fracs);
    return {q:`${n}/${d} = ?%`,a:p,t:"pct"};
  },
  conv: ()=>{
    let type=ri(0,3);
    if(type===0){ let g=ri(1,10); return {q:`${g} gallon${g>1?'s':''} = ? pints`,a:g*8,t:"conv"}; }
    if(type===1){ let p=pick([8,16,24,32,40,48,56,64]); return {q:`${p} pints = ? gallons`,a:p/8,t:"conv"}; }
    if(type===2){ let q=pick([4,8,12,16,20,24]); return {q:`${q} quarts = ? gallons`,a:q/4,t:"conv"}; }
    // yards â†” feet
    let y=ri(1,10); return {q:`${y} yard${y>1?'s':''} = ? feet`,a:y*3,t:"conv"};
  },
  roman: ()=>{
    let n=ri(1,3999);
    let r=toRoman(n);
    let sub=ri(0,1);
    if(sub===0) return {q:`${r} =`,a:n,t:"roman"};
    // Roman + or âˆ’ Roman
    let n2=ri(1,Math.min(n-1,1000));
    if(ri(0,1)===0) return {q:`${r} + ${toRoman(n2)} =`,a:n+n2,t:"roman"};
    return {q:`${r} âˆ’ ${toRoman(n2)} =`,a:n-n2,t:"roman"};
  },
  mean: ()=>{
    let ct=ri(2,5),nums=[];
    for(let i=0;i<ct;i++) nums.push(ri(10,120));
    // Force clean mean half the time
    let s=nums.reduce((a,b)=>a+b,0);
    if(s%ct!==0) nums[nums.length-1]+=(ct-(s%ct));
    s=nums.reduce((a,b)=>a+b,0);
    return {q:`The arithmetic mean of ${nums.join(", ")} =`,a:s/ct,t:"mean"};
  },
  ops: ()=>{
    let a=ri(2,25),b=ri(2,20),c=ri(1,60);
    let type=ri(0,2);
    if(type===0) return {q:`${a} Ã— ${b} + ${c} =`,a:a*b+c,t:"ops"};
    if(type===1) return {q:`${a} Ã— ${b} âˆ’ ${c} =`,a:a*b-c,t:"ops"};
    let d=ri(1,15);
    return {q:`${a} Ã— ${b} + ${c} âˆ’ ${d} =`,a:a*b+c-d,t:"ops"};
  },
  mul11: ()=>{
    let a=ri(12,9876);
    return {q:`${a} Ã— 11 =`,a:a*11,t:"mul11",hint:"Ã— 11 trick: write first & last digits, add consecutive pairs inward (carry as needed)."};
  },
  mul25: ()=>{
    let type=ri(0,1);
    if(type===0){
      let a=pick([12,16,24,32,36,44,48,52,56,64,68,72,76,84,88,96,108,124,136,148,156,164,172,184,196,204,212,236,248,312,324,336,412,448,512,524,612,712,812,912]);
      return {q:`${a} Ã— 25 =`,a:a*25,t:"mul25",hint:"Ã— 25 trick: divide by 4, then Ã— 100 (shift decimal 2 right)."};
    }
    let a=pick([12,16,24,32,36,44,48,52,56,64,68,72,76,84,88,96,108,124,136,148,156,164,172,184,196,204,212,236]);
    return {q:`${a} Ã— 75 =`,a:a*75,t:"mul25",hint:"Ã— 75 trick: divide by 4, Ã— 3, then Ã— 100."};
  },
  near100: ()=>{
    let type=ri(0,2);
    if(type===0){
      let a=ri(101,115),b=ri(101,115);
      return {q:`${a} Ã— ${b} =`,a:a*b,t:"near100",hint:"Both above 100: last 2 digits = (aâˆ’100)Ã—(bâˆ’100); rest = smaller + other's offset."};
    }
    if(type===1){
      let a=ri(85,99),b=ri(85,99);
      return {q:`${a} Ã— ${b} =`,a:a*b,t:"near100",hint:"Both below 100: last 2 digits = (100âˆ’a)Ã—(100âˆ’b); rest = smaller âˆ’ other's offset."};
    }
    let a=ri(101,112),b=ri(88,99);
    return {q:`${a} Ã— ${b} =`,a:a*b,t:"near100",hint:"Mixed (one above, one below): answer = 100Ã—(aâˆ’(100âˆ’b)âˆ’1) + (100âˆ’(aâˆ’100)Ã—(100âˆ’b))."};
  },
  sq5: ()=>{
    let bases=[15,25,35,45,55,65,75,85,95,105,115,125,135,145,155,165,175,185,195,205];
    let n=pick(bases);
    return {q:`${n}Â² =`,a:n*n,t:"sq5",hint:`Squares ending in 5: last two digits = 25; leading = (nÃ·10)Ã—(nÃ·10+1). Here: ${Math.floor(n/10)}Ã—${Math.floor(n/10)+1}=${Math.floor(n/10)*(Math.floor(n/10)+1)} â†’ answer ends ...25.`};
  },
  equidist: ()=>{
    let centers=[20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100];
    let c=pick(centers);
    let maxD=Math.min(c-1,15);
    let d=ri(1,maxD);
    let a=c-d,b=c+d;
    return {q:`${a} Ã— ${b} =`,a:a*b,t:"equidist",hint:`Equidistant trick: both are ${d} from ${c}. Answer = ${c}Â² âˆ’ ${d}Â² = ${c*c} âˆ’ ${d*d} = ${c*c-d*d}.`};
  },
  special: ()=>{
    let type=ri(0,2);
    if(type===0){
      let a=ri(1,50);
      return {q:`${a} Ã— 999 =`,a:a*999,t:"special",hint:`999 trick: n Ã— 999 = n Ã— 1000 âˆ’ n = ${a*1000} âˆ’ ${a} = ${a*999}.`};
    }
    if(type===1){
      let a=ri(1,99);
      return {q:`${a} Ã— 1001 =`,a:a*1001,t:"special",hint:`1001 trick: 1001 = 7Ã—11Ã—13. n Ã— 1001 repeats n. ${a} Ã— 1001 = ${a*1001}.`};
    }
    let a=ri(1,99);
    return {q:`${a} Ã— 10101 =`,a:a*10101,t:"special",hint:`10101 trick: 10101 = 3Ã—7Ã—13Ã—37. Repeats n in 2-digit groups. ${a} Ã— 10101 = ${a*10101}.`};
  },
  series: ()=>{
    let type=ri(0,3);
    if(type===0){
      let n=ri(5,50);
      return {q:`1 + 2 + 3 + â€¦ + ${n} =`,a:n*(n+1)/2,t:"series",hint:"Sum 1â†’n = n(n+1)/2."};
    }
    if(type===1){
      let n=ri(3,30);
      return {q:`Sum of first ${n} odd numbers =`,a:n*n,t:"series",hint:"Sum of first n odd numbers = nÂ²."};
    }
    if(type===2){
      let n=ri(3,25);
      return {q:`Sum of first ${n} even numbers =`,a:n*(n+1),t:"series",hint:"Sum of first n even numbers = n(n+1)."};
    }
    let n=ri(5,40);
    return {q:`The ${n}th triangular number =`,a:n*(n+1)/2,t:"series",hint:"T(n) = n(n+1)/2."};
  },
  fracdec: ()=>{
    let type=ri(0,2);
    if(type===0){
      let fracs=[[1,3,"0.333"],[2,3,"0.667"],[1,6,"0.167"],[5,6,"0.833"],[1,7,"0.143"],[2,7,"0.286"],[3,7,"0.429"],[4,7,"0.571"],[5,7,"0.714"],[6,7,"0.857"],
        [1,9,"0.111"],[2,9,"0.222"],[4,9,"0.444"],[7,9,"0.778"],[8,9,"0.889"],[1,11,"0.0909"],[2,11,"0.182"],[3,11,"0.273"],[5,11,"0.455"],
        [1,12,"0.0833"],[5,12,"0.417"],[7,12,"0.583"],[11,12,"0.917"]];
      let[n,d,dec]=pick(fracs);
      return {q:`${n}/${d} â‰ˆ ? (3 dec.)`,a:parseFloat(dec),t:"fracdec",hint:`1/${d} â‰ˆ ${(1/d).toFixed(4)}. Multiply by ${n}.`,starred:true};
    }
    if(type===1){
      let pcts=[[12.5,1,8],[25,1,4],[37.5,3,8],[62.5,5,8],[87.5,7,8],[16.667,1,6],[33.333,1,3],[66.667,2,3],[83.333,5,6]];
      let[p,n,d]=pick(pcts);
      return {q:`${p}% = ? (simplest fraction)`,a:`${n}/${d}`,t:"fracdec",hint:`Key: ${p}% = ${n}/${d}.`};
    }
    let decs=[[0.125,12.5],[0.375,37.5],[0.625,62.5],[0.875,87.5],[0.1667,16.67],[0.3333,33.33],[0.6667,66.67],[0.8333,83.33]];
    let[dec,pct]=pick(decs);
    return {q:`${dec} = ?%`,a:pct,t:"fracdec",hint:`Memorize: 0.125=1/8=12.5%, 0.375=3/8, etc.`,starred:true};
  },
  powers: ()=>{
    let type=ri(0,2);
    if(type===0){
      let exp=ri(2,10);
      return {q:`2^${exp} =`,a:Math.pow(2,exp),t:"powers",hint:"Powers of 2: 4,8,16,32,64,128,256,512,1024."};
    }
    if(type===1){
      let exp=ri(2,7);
      return {q:`3^${exp} =`,a:Math.pow(3,exp),t:"powers",hint:"Powers of 3: 9,27,81,243,729,2187."};
    }
    let exp=ri(2,5);
    return {q:`5^${exp} =`,a:Math.pow(5,exp),t:"powers",hint:"Powers of 5: 25,125,625,3125."};
  },
  fib: ()=>{
    let fibs=[1,1,2,3,5,8,13,21,34,55,89,144,233,377];
    let type=ri(0,2);
    if(type===0){
      let n=ri(3,14);
      return {q:`F(${n}) = ?`,a:fibs[n-1],t:"fib",hint:"Fibonacci: 1,1,2,3,5,8,13,21,34,55,89,144,233,377"};
    }
    if(type===1){
      let n=ri(4,10);
      let s=fibs.slice(0,n).reduce((a,b)=>a+b,0);
      return {q:`Sum of first ${n} Fibonacci =`,a:s,t:"fib",hint:"Sum of first n Fib = F(n+2) âˆ’ 1."};
    }
    let idx=ri(4,12);
    return {q:`${fibs[idx-1]} is which Fibonacci number?`,a:idx,t:"fib",hint:"F1=1,F2=1,F3=2,F4=3,F5=5,F6=8,F7=13,F8=21,F9=34,F10=55,F11=89,F12=144."};
  },
  polygon: ()=>{
    let type=ri(0,2);
    if(type===0){
      let n=ri(3,12);
      let s=180*(n-2);
      let names=["","","","triangle","quadrilateral","pentagon","hexagon","heptagon","octagon","nonagon","decagon","hendecagon","dodecagon"];
      return {q:`Sum of interior angles of a ${names[n]} =`,a:s,t:"polygon",hint:"Interior angle sum = 180 Ã— (n âˆ’ 2)."};
    }
    if(type===1){
      let n=ri(4,12);
      return {q:`Diagonals in a ${n}-gon =`,a:n*(n-3)/2,t:"polygon",hint:"Diagonals = n(nâˆ’3)/2."};
    }
    let n=pick([3,4,5,6,8,9,10,12]);
    return {q:`Each interior angle of regular ${n}-gon =`,a:180*(n-2)/n,t:"polygon",hint:"Each interior angle = 180(nâˆ’2)/n."};
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOPIC METADATA â€“ maps topic key â†’ display info + which generators to use
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TOPICS = {
  add:      {name:"Addition",       icon:"â•", gens:["add"]},
  sub:      {name:"Subtraction",    icon:"â–", gens:["sub"]},
  mul:      {name:"Multiplication", icon:"âœ–ï¸",  gens:["mul"]},
  div:      {name:"Division",       icon:"â—", gens:["div"]},
  sq:       {name:"Squares",        icon:"Â²",  gens:["sq"]},
  cube:     {name:"Cubes",          icon:"Â³",  gens:["cube"]},
  rem:      {name:"Remainders",     icon:"ğŸ”", gens:["rem"]},
  lcm:      {name:"LCM & GCD",     icon:"ğŸ”¢", gens:["lcm","gcd"]},
  pct:      {name:"Percentages",    icon:"%",  gens:["pct"]},
  conv:     {name:"Conversions",    icon:"ğŸ”„", gens:["conv"]},
  roman:    {name:"Roman Numerals", icon:"â…©",  gens:["roman"]},
  mean:     {name:"Mean & Ops",     icon:"ğŸ“Š", gens:["mean","ops"]},
  mul11:    {name:"Ã— 11 Trick",     icon:"â›“", gens:["mul11"]},
  mul25:    {name:"Ã— 25 / Ã— 75",   icon:"Â¼",  gens:["mul25"]},
  near100:  {name:"Near 100",       icon:"ğŸ’¯", gens:["near100"]},
  sq5:      {name:"Squares (Ã·5)",   icon:"âµÂ²", gens:["sq5","equidist"]},
  special:  {name:"Special Ints",   icon:"ğŸ¯", gens:["special"]},
  series:   {name:"Series Sums",    icon:"âˆ‘",  gens:["series"]},
  fracdec:  {name:"Fracâ†”Dec",       icon:"â…›",  gens:["fracdec"]},
  powers:   {name:"Powers 2/3/5",   icon:"2â¿", gens:["powers"]},
  fib:      {name:"Fibonacci",      icon:"ğŸŒ€", gens:["fib"]},
  polygon:  {name:"Polygons",       icon:"â¬¡",  gens:["polygon"]},
};
const ALL_GEN_KEYS = Object.keys(GEN);
const CORE_GEN_KEYS = ['add','sub','mul','div','sq','cube','rem','lcm','gcd','pct','conv','roman','mean','ops'];
const TRICK_GEN_KEYS = ['mul11','mul25','near100','sq5','equidist','special','series','fracdec','powers','fib','polygon'];

function pickGen(){
  // 70% core, 30% trick drill
  if(ri(0,9)<7) return pick(CORE_GEN_KEYS);
  return pick(TRICK_GEN_KEYS);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POOL BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildBasicPool(count, topicKey) {
  let pool = [];
  if(topicKey){
    // Filter real problems to matching type(s)
    let matchTypes = topicKey==="lcm" ? ["lcm","gcd"] : [topicKey];
    pool = REAL_BASIC.filter(p=>matchTypes.includes(p.t));
    let gens = TOPICS[topicKey].gens;
    while(pool.length < count*4) pool.push(GEN[pick(gens)]());
  } else {
    pool = [...REAL_BASIC];
    while(pool.length < count*4) pool.push(GEN[pickGen()]());
  }
  
  let problems = shuffle(pool).slice(0,count);
  
  // Insert starred problems at positions 10, 20, 30, etc. in drill mode (not topic drills)
  if(!topicKey && count >= 10){
    for(let pos=10; pos<=count; pos+=10){
      if(pos===10){
        problems[9] = {...APPROX.tier1(),num:10};
      } else if(pos===20){
        problems[19] = {...APPROX.tier1hard(),num:20};
      } else {
        // For positions 30+, use advanced starred problems
        problems[pos-1] = {...APPROX.advanced(),num:pos};
      }
    }
  }
  
  return problems;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPROXIMATION (*) GENERATORS â€” For problems #10, 20, 30, 40, 50, 60, 70, 80
// These are starred (*) problems but have EXACT answers - just large/tricky numbers
// The Â±5% tolerance is a safety net, not an invitation to estimate
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APPROX = {
  // Problem 10: Four-term arithmetic chain (AUTHENTIC UIL PATTERN)
  // Real UIL examples:
  //   520 âˆ’ 2011 + 1302 âˆ’ 25 =
  //   425 âˆ’ 2025 + 5202 âˆ’ 624 =
  //   1967 + 7196 âˆ’ 6719 âˆ’ 9671 =
  //   5220 âˆ’ 522 âˆ’ 2052 âˆ’ 2205 =
  tier1: ()=>{
    let pattern=ri(0,4);
    
    // Pattern 1: small âˆ’ large + large âˆ’ medium
    if(pattern===0){
      let a=ri(300,900);
      let b=ri(1500,2500);
      let c=ri(3000,6000);
      let d=ri(100,800);
      let ans=a-b+c-d;
      return {q:`${a} âˆ’ ${b} + ${c} âˆ’ ${d} =`,a:ans,t:"ops",starred:true,hint:"Work left to right: "+a+"âˆ’"+b+" = "+(a-b)+", +"+c+" = "+(a-b+c)+", âˆ’"+d+" = "+ans};
    }
    
    // Pattern 2: large + large âˆ’ large âˆ’ large
    if(pattern===1){
      let a=ri(1000,3000);
      let b=ri(5000,8000);
      let c=ri(4000,7000);
      let d=ri(3000,10000);
      let ans=a+b-c-d;
      return {q:`${a} + ${b} âˆ’ ${c} âˆ’ ${d} =`,a:ans,t:"ops",starred:true,hint:"Add: "+a+"+"+b+" = "+(a+b)+", subtract: âˆ’"+c+"âˆ’"+d};
    }
    
    // Pattern 3: large âˆ’ small âˆ’ large âˆ’ large
    if(pattern===2){
      let a=ri(4000,7000);
      let b=ri(400,900);
      let c=ri(1500,2500);
      let d=ri(1500,3000);
      let ans=a-b-c-d;
      return {q:`${a} âˆ’ ${b} âˆ’ ${c} âˆ’ ${d} =`,a:ans,t:"ops",starred:true,hint:"Subtract sequentially: "+a+"âˆ’"+b+" = "+(a-b)+", âˆ’"+c+" = "+(a-b-c)+", âˆ’"+d};
    }
    
    // Pattern 4: small + large âˆ’ large + medium
    if(pattern===3){
      let a=ri(200,600);
      let b=ri(2000,4000);
      let c=ri(1500,3000);
      let d=ri(500,1500);
      let ans=a+b-c+d;
      return {q:`${a} + ${b} âˆ’ ${c} + ${d} =`,a:ans,t:"ops",starred:true,hint:"Group: ("+a+"+"+b+"+"+d+") âˆ’ "+c};
    }
    
    // Pattern 5: small âˆ’ large + large âˆ’ small (balanced)
    let a=ri(400,800);
    let b=ri(1800,2500);
    let c=ri(3000,4500);
    let d=ri(300,700);
    let ans=a-b+c-d;
    return {q:`${a} âˆ’ ${b} + ${c} âˆ’ ${d} =`,a:ans,t:"ops",starred:true,hint:"Left to right: "+a+"âˆ’"+b+" = "+(a-b)+", then +"+c+"âˆ’"+d};
  },
  
  // Problem 20: Division by 25 OR large operations (AUTHENTIC UIL PATTERN)
  // Real UIL examples:
  //   1103 Ã· 25 =
  //   âˆš518 Ã— âˆš7491 = (which is âˆš(518Ã—7491))
  //   172023 Ã· 218 =
  //   396 Ã— 501 âˆ’ 2020 =
  tier1hard: ()=>{
    let type=ri(0,5);
    
    // Type 1: Division by 25 (MOST COMMON)
    if(type===0){
      let quotient=ri(40,150);
      let dividend=quotient*25;
      return {q:`${dividend} Ã· 25 =`,a:quotient,t:"div",starred:true,hint:"Ã·25 trick: "+dividend+" Ã— 4 = "+(dividend*4)+", Ã·100 = "+quotient};
    }
    
    // Type 2: Large 3-digit Ã— 3-digit multiplication
    if(type===1){
      let a=ri(250,500);
      let b=ri(250,600);
      let ans=a*b;
      return {q:`${a} Ã— ${b} =`,a:ans,t:"mul",starred:true,hint:"Distributive: "+a+"Ã—"+b+" = "+a+"Ã—"+Math.floor(b/100)*100+" + "+a+"Ã—"+(b%100)};
    }
    
    // Type 3: âˆša + âˆšb where a, b are perfect squares
    if(type===2){
      let a=ri(18,26);
      let b=ri(18,28);
      let ans=a+b;
      return {q:`âˆš${a*a} + âˆš${b*b} =`,a:ans,t:"sq",starred:true,hint:"âˆš"+(a*a)+" = "+a+", âˆš"+(b*b)+" = "+b+", sum = "+ans};
    }
    
    // Type 4: Large product minus constant
    if(type===3){
      let a=ri(300,500);
      let b=ri(400,600);
      let c=ri(1500,3000);
      let ans=a*b-c;
      return {q:`${a} Ã— ${b} âˆ’ ${c} =`,a:ans,t:"ops",starred:true,hint:"Multiply first: "+a+"Ã—"+b+" = "+(a*b)+", âˆ’"+c+" = "+ans};
    }
    
    // Type 5: Large division with clean answer
    if(type===4){
      let divisor=ri(150,400);
      let quotient=ri(200,900);
      let dividend=divisor*quotient;
      return {q:`${dividend} Ã· ${divisor} =`,a:quotient,t:"div",starred:true,hint:"Factor: "+dividend+" = "+divisor+" Ã— "+quotient};
    }
    
    // Type 6: Product of large-ish numbers (near 100)
    let a=ri(90,150);
    let b=ri(90,150);
    return {q:`${a} Ã— ${b} =`,a:a*b,t:"mul",starred:true,hint:"Use (100Â±a)(100Â±b) pattern or distributive"};
  },
  
  // Problem 30: Tier 2 starred
  tier2: ()=>{
    let type=ri(0,2);
    if(type===0){
      // Product of square roots
      let a=ri(10,20),b=ri(10,20);
      return {q:`âˆš${a*a} Ã— âˆš${b*b} =`,a:a*b,t:"sq",starred:true,hint:"âˆš"+(a*a)+"="+a+", âˆš"+(b*b)+"="+b+", product = "+(a*b)};
    }
    if(type===1){
      // Cube root of perfect cube
      let n=ri(10,15);
      return {q:`Â³âˆš${n*n*n} =`,a:n,t:"cube",starred:true,hint:"Memorize cubes: 10Â³=1000, 11Â³=1331, 12Â³=1728, 13Â³=2197, 14Â³=2744, 15Â³=3375"};
    }
    // Large mixed operations
    let a=ri(100,500),b=ri(100,500),c=ri(2,9);
    let ans=(a+b)*c;
    return {q:`(${a} + ${b}) Ã— ${c} =`,a:ans,t:"ops",starred:true,hint:"Add first: "+a+"+"+b+"="+(a+b)+", then Ã—"+c};
  },
  
  // Problem 40-80: Higher tier starred
  advanced: ()=>{
    let type=ri(0,4);
    if(type===0){
      // Fourth root of perfect fourth power
      let n=ri(5,10);
      return {q:`â´âˆš${Math.pow(n,4)} =`,a:n,t:"powers",starred:true,hint:"4th roots: 5â´=625, 6â´=1296, 7â´=2401, 8â´=4096, 9â´=6561, 10â´=10000"};
    }
    if(type===1){
      // Product of three square roots
      let a=ri(8,15),b=ri(8,15),c=ri(8,15);
      return {q:`âˆš${a*a} Ã— âˆš${b*b} Ã— âˆš${c*c} =`,a:a*b*c,t:"sq",starred:true,hint:"âˆš"+(a*a)+"Ã—âˆš"+(b*b)+"Ã—âˆš"+(c*c)+" = "+a+"Ã—"+b+"Ã—"+c};
    }
    if(type===2){
      // Complex arithmetic chain
      let a=ri(50,100),b=ri(50,100),c=ri(30,70);
      let ans=a*a-b*b+c;
      return {q:`${a}Â² âˆ’ ${b}Â² + ${c} =`,a:ans,t:"ops",starred:true,hint:"Use difference of squares: "+a+"Â²âˆ’"+b+"Â² = ("+a+"+"+b+")("+a+"âˆ’"+b+")"};
    }
    if(type===3){
      // Large factorial divided by factorial
      let n=ri(8,12),k=ri(5,n-2);
      let ans=1; for(let i=k+1;i<=n;i++) ans*=i;
      return {q:`${n}! Ã· ${k}! =`,a:ans,t:"factperm",starred:true,hint:n+"! Ã· "+k+"! = "+n+"Ã—"+(n-1)+"Ã—...Ã—"+(k+1)};
    }
    // Sum/product of large square roots
    let a=ri(12,20),b=ri(12,20);
    if(ri(0,1)===0){
      return {q:`âˆš${a*a} + âˆš${b*b} + âˆš${(a+b)*(a+b)} =`,a:a+b+(a+b),t:"sq",starred:true,hint:"Simplify each root, then add"};
    }
    return {q:`(âˆš${a*a} + âˆš${b*b}) Ã— ${ri(2,5)} =`,a:(a+b)*ri(2,5),t:"ops",starred:true,hint:"Roots first, then multiply"};
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIER 2 GENERATORS â€” Problems 21-40
// Powers, Substitution, Abs Value, Ratio, Roots, Sets,
// Base Conversion, Equations, Repeating Decimals, Area/Perimeter, Sequences
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEN2 = {
  powers: ()=>{
    let type=ri(0,3);
    if(type===0){ let b=ri(2,9),e=ri(3,5); return {q:`${b}^${e} =`,a:Math.pow(b,e),t:"powers"}; }
    if(type===1){ let b=ri(2,5),e=ri(4,6); return {q:`${b}^${e} =`,a:Math.pow(b,e),t:"powers"}; }
    if(type===2){
      // product of powers: a^m Ã— a^n = a^(m+n)
      let b=pick([2,3,5]),m=ri(1,4),n=ri(1,3);
      return {q:`${b}^${m} Ã— ${b}^${n} = ${b}^?`,a:m+n,t:"powers"};
    }
    let a=ri(2,4),m=ri(2,3),n=ri(2,3);
    return {q:`(${a}^${m})^${n} =`,a:Math.pow(a,m*n),t:"powers"};
  },
  subst: ()=>{
    let x=ri(2,12);
    let type=ri(0,3);
    if(type===0){ let a=ri(2,8),b=ri(1,20); return {q:`If x = ${x}, then ${a}x + ${b} =`,a:a*x+b,t:"subst"}; }
    if(type===1){ let a=ri(1,6),b=ri(1,6); return {q:`If x = ${x}, then xÂ² + ${a}x âˆ’ ${b} =`,a:x*x+a*x-b,t:"subst"}; }
    if(type===2){ let a=ri(2,5); return {q:`If x = ${x}, then ${a}xÂ² =`,a:a*x*x,t:"subst"}; }
    let a=ri(1,5),b=ri(1,5),c=ri(1,30);
    return {q:`If x = ${x}, then ${a}xÂ² âˆ’ ${b}x + ${c} =`,a:a*x*x-b*x+c,t:"subst"};
  },
  absval: ()=>{
    let type=ri(0,2);
    if(type===0){ let a=ri(-50,-1); return {q:`|${a}| =`,a:Math.abs(a),t:"absval"}; }
    if(type===1){ let a=ri(-30,30),b=ri(-30,30); return {q:`|${a}| + |${b}| =`,a:Math.abs(a)+Math.abs(b),t:"absval"}; }
    let a=ri(-20,20),b=ri(-20,20);
    let bStr = b<0 ? `(${b})` : `${b}`;
    return {q:`|${a} âˆ’ ${bStr}| =`,a:Math.abs(a-b),t:"absval"};
  },
  ratio: ()=>{
    let type=ri(0,2);
    if(type===0){
      let a=ri(2,12),b=ri(2,12),c=a*ri(2,6);
      return {q:`${a} : ${b} = ${c} : ?`,a:b*(c/a),t:"ratio"};
    }
    if(type===1){
      let a=ri(2,10),b=ri(2,10),k=ri(2,5);
      return {q:`${a}/${b} = ${a*k}/x. Find x.`,a:b*k,t:"ratio"};
    }
    let a=ri(1,5),b=ri(1,5),total=(a+b)*ri(2,8);
    let partA=total*a/(a+b);
    return {q:`Split ${total} in ratio ${a}:${b}. Smaller part =`,a:Math.min(partA,total-partA),t:"ratio"};
  },
  sqrtcube: ()=>{
    let type=ri(0,2);
    if(type===0){ let n=ri(2,30); return {q:`âˆš${n*n} =`,a:n,t:"sqrtcube"}; }
    if(type===1){ let n=ri(2,15); return {q:`âˆ›${n*n*n} =`,a:n,t:"sqrtcube"}; }
    let a=ri(2,20),b=ri(2,20);
    return {q:`âˆš${a*a} + âˆš${b*b} =`,a:a+b,t:"sqrtcube"};
  },
  sets: ()=>{
    let shared=ri(1,3), onlyA=ri(1,3), onlyB=ri(1,3);
    let nums=shuffle([1,2,3,4,5,6,7,8,9,10,11,12]);
    let A=[...nums.slice(0,onlyA),...nums.slice(6,6+shared)].sort((a,b)=>a-b);
    let B=[...nums.slice(onlyA,onlyA+onlyB),...nums.slice(6,6+shared)].sort((a,b)=>a-b);
    let type=ri(0,2);
    if(type===0){
      let inter=nums.slice(6,6+shared);
      return {q:`A={${A.join(',')}} B={${B.join(',')}} |Aâˆ©B| =`,a:inter.length,t:"sets"};
    }
    if(type===1){
      let union=[...new Set([...A,...B])];
      return {q:`A={${A.join(',')}} B={${B.join(',')}} |AâˆªB| =`,a:union.length,t:"sets"};
    }
    let n=ri(3,5);
    return {q:`How many subsets does a ${n}-element set have?`,a:Math.pow(2,n),t:"sets"};
  },
  base: ()=>{
    let type=ri(0,2);
    if(type===0){
      let val=ri(1,255);
      return {q:`${val.toString(2)}â‚‚ = ? (base 10)`,a:val,t:"base"};
    }
    if(type===1){
      let val=ri(1,31);
      return {q:`${val} in base 2 =`,a:parseInt(val.toString(2)),t:"base"};
    }
    let val=ri(8,511);
    if(ri(0,1)===0) return {q:`${val.toString(8)}â‚ˆ = ? (base 10)`,a:val,t:"base"};
    let val2=ri(1,63);
    return {q:`${val2} in base 8 =`,a:parseInt(val2.toString(8)),t:"base"};
  },
  equations: ()=>{
    let type=ri(0,2);
    if(type===0){
      let x=ri(-10,20), a=ri(1,8), b=ri(-20,20);
      let bStr = b>=0 ? `+ ${b}` : `âˆ’ ${Math.abs(b)}`;
      let aStr = a===1?'x':`${a}x`;
      return {q:`${aStr} ${bStr} = ${a*x+b}. x =`,a:x,t:"equations"};
    }
    if(type===1){
      let x=ri(1,15), a=ri(2,6), b=ri(1,30);
      let aStr = a===1?'x':`${a}x`;
      return {q:`${aStr} âˆ’ ${b} = ${a*x-b}. x =`,a:x,t:"equations"};
    }
    let b=ri(2,6), c=ri(2,10), a=ri(1,15);
    return {q:`(x + ${a}) Ã· ${b} = ${c}. x =`,a:b*c-a,t:"equations"};
  },
  repdec: ()=>{
    let type=ri(0,2);
    if(type===0){
      let a=ri(1,8);
      return {q:`0.${a}${a}${a}â€¦ = ? (fraction)`,a:`${a}/9`,t:"repdec"};
    }
    if(type===1){
      let a=ri(1,9),b=ri(0,9);
      let num=a*10+b, g=gcd(num,99);
      return {q:`0.${a}${b}${a}${b}â€¦ = ? (fraction)`,a:`${num/g}/${99/g}`,t:"repdec"};
    }
    let known=[[1,3,"0.333â€¦"],[2,3,"0.667â€¦"],[1,6,"0.167â€¦"],[5,6,"0.833â€¦"],[1,7,"0.143â€¦"],[1,9,"0.111â€¦"],[2,9,"0.222â€¦"],[1,11,"0.0909â€¦"]];
    let[n,d,dec]=pick(known);
    return {q:`${dec} = ? (fraction)`,a:`${n}/${d}`,t:"repdec"};
  },
  areaperi: ()=>{
    let type=ri(0,3);
    if(type===0){ let l=ri(3,25),w=ri(2,15); return {q:`Area of rectangle ${l} Ã— ${w} =`,a:l*w,t:"areaperi"}; }
    if(type===1){ let r=ri(1,10); return {q:`Area of circle r=${r} = ?Ï€`,a:r*r,t:"areaperi"}; }
    if(type===2){
      let b=ri(4,24),h=ri(2,20);
      if((b*h)%2!==0) h+=1;
      return {q:`Area of triangle, base=${b}, height=${h} =`,a:b*h/2,t:"areaperi"};
    }
    let d=ri(2,20);
    return {q:`Circumference of circle, diameter=${d} = ?Ï€`,a:d,t:"areaperi"};
  },
  sequences: ()=>{
    let type=ri(0,2);
    if(type===0){
      let a=ri(1,20),d=ri(1,10);
      let terms=[a,a+d,a+2*d,a+3*d];
      return {q:`${terms.join(', ')}, â€¦ next term =`,a:a+4*d,t:"sequences"};
    }
    if(type===1){
      let a=ri(1,5),r=ri(2,4);
      let terms=[a,a*r,a*r*r,a*r*r*r];
      return {q:`${terms.join(', ')}, â€¦ next term =`,a:a*Math.pow(r,4),t:"sequences"};
    }
    // nth term of arithmetic sequence
    let a=ri(1,10),d=ri(1,8),n=ri(5,15);
    return {q:`aâ‚=${a}, d=${d}. Find a${n}.`,a:a+(n-1)*d,t:"sequences"};
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIER 3 GENERATORS â€” Problems 41-60
// Exponents, Right Triangles, Coord Geo, Variation, Complex, Logs,
// Factorials/Perms/Combs, Probability, Binomial
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEN3 = {
  exponents: ()=>{
    let type=ri(0,3);
    if(type===0){ let a=ri(2,5),m=ri(1,4),n=ri(1,4); return {q:`${a}^${m} Ã— ${a}^${n} = ${a}^?`,a:m+n,t:"exponents"}; }
    if(type===1){ let a=ri(2,5),m=ri(4,8),n=ri(1,3); return {q:`${a}^${m} Ã· ${a}^${n} = ${a}^?`,a:m-n,t:"exponents"}; }
    if(type===2){ let a=ri(2,4),m=ri(2,3),n=ri(2,3); return {q:`(${a}^${m})^${n} = ${a}^?`,a:m*n,t:"exponents"}; }
    let a=ri(2,4),e=ri(2,5);
    return {q:`${a}^${e} =`,a:Math.pow(a,e),t:"exponents"};
  },
  triangle: ()=>{
    let triples=[[3,4,5],[5,12,13],[8,15,17],[7,24,25],[6,8,10],[9,12,15],[12,16,20],[9,40,41],[20,21,29],[11,60,61],[15,20,25]];
    let[a,b,c]=pick(triples);
    let k=pick([1,2,3]);
    let type=ri(0,2);
    if(type===0) return {q:`Right â–³: legs ${a*k}, ${b*k}. Hypotenuse =`,a:c*k,t:"triangle"};
    if(type===1) return {q:`Right â–³: leg ${a*k}, hyp ${c*k}. Other leg =`,a:b*k,t:"triangle"};
    return {q:`Right â–³: leg ${b*k}, hyp ${c*k}. Other leg =`,a:a*k,t:"triangle"};
  },
  coordgeo: ()=>{
    let type=ri(0,2);
    if(type===0){
      let triples=[[3,4,5],[5,12,13],[6,8,10],[8,15,17],[9,12,15]];
      let[dx,dy,d]=pick(triples);
      let x1=ri(-5,5),y1=ri(-5,5);
      return {q:`Distance: (${x1},${y1}) to (${x1+dx},${y1+dy}) =`,a:d,t:"coordgeo"};
    }
    if(type===1){
      let x1=ri(-10,10),y1=ri(-10,10),x2=ri(-10,10),y2=ri(-10,10);
      if((x1+x2)%2!==0) x2+=1;
      if((y1+y2)%2!==0) y2+=1;
      return {q:`Midpoint of (${x1},${y1}) & (${x2},${y2}): x =`,a:(x1+x2)/2,t:"coordgeo"};
    }
    let x1=ri(-5,5),y1=ri(-5,10),x2,y2;
    do{ x2=ri(-5,5); }while(x2===x1);
    y2=ri(-5,10);
    let num=y2-y1, den=x2-x1, g=gcd(Math.abs(num),Math.abs(den));
    let sn=num/g,sd=den/g;
    if(sd<0){sn=-sn;sd=-sd;}
    let slopeAns = sd===1 ? sn : `${sn}/${sd}`;
    return {q:`Slope: (${x1},${y1}) to (${x2},${y2}) =`,a:slopeAns,t:"coordgeo"};
  },
  variation: ()=>{
    if(ri(0,1)===0){
      let k=ri(2,10),x1=ri(1,8),x2=ri(1,8);
      return {q:`y varies directly as x. y=${k*x1} when x=${x1}. y when x=${x2} =`,a:k*x2,t:"variation"};
    }
    let x1=ri(1,8),x2=ri(1,8);
    let k=x1*ri(2,10);
    let y2=k/x2;
    if(y2!==Math.floor(y2)){x2=pick([1,2,4,5,8,10].filter(v=>k%v===0));y2=k/x2;}
    return {q:`y varies inversely as x. y=${k/x1} when x=${x1}. y when x=${x2} =`,a:y2,t:"variation"};
  },
  complex: ()=>{
    let type=ri(0,2);
    if(type===0){
      let a=ri(-5,5),b=ri(-5,5),c=ri(-5,5),d=ri(-5,5);
      let rr=a+c,im=b+d;
      // Build clean answer string
      let ans;
      if(im===0) ans=`${rr}`;
      else if(rr===0) ans = im===1?'i':im===-1?'âˆ’i':`${im<0?'âˆ’':''}${Math.abs(im)}i`;
      else {
        let imPart = im===1?'+i':im===-1?'âˆ’i':(im>0?`+${im}i`:`${im}i`);
        ans = `${rr}${imPart}`;
      }
      // Build clean question strings
      let bPart = b===0?'':(b>0?`+${b===1?'i':`${b}i`}`:(b===-1?'âˆ’i':`${b}i`));
      let dPart = d===0?'':(d>0?`+${d===1?'i':`${d}i`}`:(d===-1?'âˆ’i':`${d}i`));
      return {q:`(${a}${bPart}) + (${c}${dPart}) =`,a:ans,t:"complex"};
    }
    if(type===1){
      let n=ri(1,20);
      let cycle=['i','âˆ’1','âˆ’i','1'];
      return {q:`i^${n} =`,a:cycle[(n-1)%4],t:"complex"};
    }
    let triples=[[3,4,5],[5,12,13],[6,8,10],[8,15,17],[9,12,15]];
    let[a,b,c]=pick(triples);
    if(ri(0,1)) return {q:`|${a} + ${b}i| =`,a:c,t:"complex"};
    return {q:`|${b} + ${a}i| =`,a:c,t:"complex"};
  },
  logs: ()=>{
    let type=ri(0,2);
    if(type===0){
      let b=pick([2,3,5,10]),n=ri(1,6);
      return {q:`log${b}(${Math.pow(b,n)}) =`,a:n,t:"logs"};
    }
    if(type===1){
      let a=ri(2,9),b=ri(2,9);
      return {q:`log(${a}) + log(${b}) = log(?)`,a:a*b,t:"logs"};
    }
    let n=ri(1,8);
    return {q:`log(${Math.pow(10,n)}) =`,a:n,t:"logs"};
  },
  factperm: ()=>{
    let type=ri(0,2);
    if(type===0){
      let n=ri(1,8), f=1; for(let i=2;i<=n;i++) f*=i;
      return {q:`${n}! =`,a:f,t:"factperm"};
    }
    if(type===1){
      let n=ri(4,8),r=ri(2,Math.min(n,4));
      let p=1; for(let i=n;i>n-r;i--) p*=i;
      return {q:`P(${n},${r}) =`,a:p,t:"factperm"};
    }
    let n=ri(4,8),r=ri(1,Math.min(n,4));
    let num=1,den=1;
    for(let i=0;i<r;i++){num*=(n-i);den*=(i+1);}
    return {q:`C(${n},${r}) =`,a:num/den,t:"factperm"};
  },
  probability: ()=>{
    let type=ri(0,2);
    if(type===0){
      let targets={2:1,3:2,4:3,5:4,6:5,7:6,8:5,9:4,10:3,11:2,12:1};
      let t=pick([2,3,4,5,6,7,8,9,10,11,12]);
      let num=targets[t],den=36,g=gcd(num,den);
      return {q:`P(sum=${t} on 2 dice) =`,a:`${num/g}/${den/g}`,t:"probability"};
    }
    if(type===1){
      let suits=['heart','diamond','club','spade'];
      return {q:`P(drawing a ${pick(suits)} from a deck) =`,a:`1/4`,t:"probability"};
    }
    let n=ri(2,5);
    return {q:`P(${n} heads in ${n} flips) =`,a:`1/${Math.pow(2,n)}`,t:"probability"};
  },
  binomial: ()=>{
    if(ri(0,1)===0){
      let n=ri(4,10),k=ri(1,Math.min(n,5));
      let num=1,den=1;
      for(let i=0;i<k;i++){num*=(n-i);den*=(i+1);}
      return {q:`Coefficient of x^${k} in (1+x)^${n} =`,a:num/den,t:"binomial"};
    }
    let n=ri(3,10);
    return {q:`Sum of row ${n} of Pascal's triangle =`,a:Math.pow(2,n),t:"binomial"};
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIER 4 GENERATORS â€” Problems 61-70
// Volume/Surface Area, Trig, Composite Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEN4 = {
  volume: ()=>{
    let type=ri(0,3);
    if(type===0){ let s=ri(2,10); return {q:`Volume of cube, side=${s} =`,a:s*s*s,t:"volume"}; }
    if(type===1){ let l=ri(2,8),w=ri(2,6),h=ri(2,5); return {q:`Volume of box ${l}Ã—${w}Ã—${h} =`,a:l*w*h,t:"volume"}; }
    if(type===2){
      let r=ri(1,5), num=4*r*r*r;
      if(num%3===0) return {q:`Volume of sphere r=${r} = ?Ï€`,a:num/3,t:"volume"};
      return {q:`Surface area of sphere r=${r} = ?Ï€`,a:4*r*r,t:"volume"};
    }
    let r=ri(1,6),h=ri(2,8);
    return {q:`Volume of cylinder r=${r}, h=${h} = ?Ï€`,a:r*r*h,t:"volume"};
  },
  trig: ()=>{
    // Use right triangles with known sides to get clean numeric trig answers
    // Format: "In right â–³ with sides a, b, hyp c â€” find sin/cos/tan of the angle opposite side X"
    let triangles = [
      {a:3,b:4,c:5}, {a:5,b:12,c:13}, {a:8,b:15,c:17},
      {a:7,b:24,c:25}, {a:6,b:8,c:10}, {a:9,b:12,c:15},
      {a:9,b:40,c:41}, {a:20,b:21,c:29}
    ];
    let tri = pick(triangles);
    let type = ri(0,2);
    // Pick which angle (opposite 'a' or opposite 'b')
    let opp = ri(0,1)===0 ? tri.a : tri.b;
    let adj = opp===tri.a ? tri.b : tri.a;
    if(type===0){
      // sin = opp/hyp
      let g=gcd(opp,tri.c), ans = opp/g===1&&tri.c/g===1 ? `${opp}` : `${opp/g}/${tri.c/g}`;
      return {q:`Right â–³ sides ${tri.a}, ${tri.b}, ${tri.c}. sin(angle opp ${opp}) =`,a:`${opp/g}/${tri.c/g}`,t:"trig"};
    }
    if(type===1){
      // cos = adj/hyp
      let g=gcd(adj,tri.c);
      return {q:`Right â–³ sides ${tri.a}, ${tri.b}, ${tri.c}. cos(angle opp ${opp}) =`,a:`${adj/g}/${tri.c/g}`,t:"trig"};
    }
    // tan = opp/adj
    let g=gcd(opp,adj);
    if(opp/g===1 && adj/g===1) return {q:`Right â–³ sides ${tri.a}, ${tri.b}, ${tri.c}. tan(angle opp ${opp}) =`,a:`${opp/g}/${adj/g}`,t:"trig"};
    return {q:`Right â–³ sides ${tri.a}, ${tri.b}, ${tri.c}. tan(angle opp ${opp}) =`,a:`${opp/g}/${adj/g}`,t:"trig"};
  },
  compfunc: ()=>{
    let a=ri(1,4),b=ri(-5,5),c=ri(1,3),d=ri(-4,4),n=ri(1,6);
    let gn=c*n+d, fgn=a*gn+b;
    let fStr = (a===1?'x':`${a}x`) + (b>=0?` + ${b}`:` âˆ’ ${Math.abs(b)}`);
    let gStr = (c===1?'x':`${c}x`) + (d>=0?` + ${d}`:` âˆ’ ${Math.abs(d)}`);
    return {q:`f(x) = ${fStr}, g(x) = ${gStr}. f(g(${n})) =`,a:fgn,t:"compfunc"};
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIER 5 GENERATORS â€” Problems 71-80
// Calculus (limits, derivatives, integrals), Max/Min, Asymptotes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEN5 = {
  calculus: ()=>{
    let type=ri(0,3);
    if(type===0){
      let n=ri(2,6),x=ri(1,4);
      return {q:`d/dx(x^${n}) at x = ${x} =`,a:n*Math.pow(x,n-1),t:"calculus"};
    }
    if(type===1){
      let a=ri(1,5),n=ri(2,5);
      return {q:`d/dx(${a}x^${n}) = ${a*n}x^?`,a:n-1,t:"calculus"};
    }
    if(type===2){
      let a=ri(1,5),c=ri(1,8),d=ri(-10,10);
      let cStr = c===1?'x':`${c}x`;
      let dStr = d>=0 ? ` + ${d}` : ` âˆ’ ${Math.abs(d)}`;
      return {q:`lim xâ†’${a} of (${cStr}${dStr}) =`,a:c*a+d,t:"calculus"};
    }
    let n=ri(1,3),a=ri(1,4);
    let val=Math.pow(a,n+1)/(n+1);
    if(val===Math.floor(val)) return {q:`âˆ«â‚€^${a} x^${n} dx =`,a:val,t:"calculus"};
    let nn=ri(2,5),xx=ri(1,3);
    return {q:`d/dx(x^${nn}) at x = ${xx} =`,a:nn*Math.pow(xx,nn-1),t:"calculus"};
  },
  maxmin: ()=>{
    let a=pick([-3,-2,-1,1,2,3]);
    let vx=ri(-4,4), b=-2*a*vx, vy=ri(-10,10), c=vy-a*vx*vx;
    let word=a>0?'minimum':'maximum';
    // Build pretty quadratic string
    let aStr = a===1?'xÂ²':a===-1?'âˆ’xÂ²':`${a}xÂ²`;
    let bStr = b===0?'':b>0?` + ${b===1?'x':`${b}x`}`:` âˆ’ ${Math.abs(b)===1?'x':`${Math.abs(b)}x`}`;
    let cStr = c===0?'':c>0?` + ${c}`:` âˆ’ ${Math.abs(c)}`;
    return {q:`y = ${aStr}${bStr}${cStr}. ${word} value of y =`,a:vy,t:"maxmin"};
  },
  asymptote: ()=>{
    if(ri(0,1)===0){
      let a=ri(1,8),b=ri(1,8),g=gcd(a,b);
      let ans=a/b===Math.floor(a/b)?`${a/b}`:`${a/g}/${b/g}`;
      return {q:`Horiz. asymptote of y = (${a}xÂ² + 3x) / (${b}xÂ² + 1) =`,a:ans,t:"asymptote"};
    }
    let a=ri(-5,5);
    let xStr = a>=0 ? `x âˆ’ ${a}` : `x + ${Math.abs(a)}`;
    return {q:`Vert. asymptote of y = 1/(${xStr}) is x =`,a:a,t:"asymptote"};
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UIL SEQUENCING CHART â€” ordered topic slots per band
// Each sub-array lists generator keys valid for that problem position.
// Within each band, topics appear in the order UIL prescribes.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Problems 1-20
const SEQ_1_20 = [
  ['add'],                          // 1  â€” addition
  ['sub'],                          // 2  â€” subtraction
  ['add','sub'],                    // 3  â€” add or sub
  ['mul'],                          // 4  â€” multiplication
  ['mul','ops'],                    // 5  â€” mult / order-of-ops
  ['ops'],                          // 6  â€” order of operations
  ['mul','mul11','mul25','near100','equidist','sq5','special'], // 7  â€” mult shortcuts
  ['mul11','mul25','near100','equidist'], // 8  â€” mult shortcuts
  ['sq'],                           // 9  â€” squaring
  ['sq','sq5'],                     // 10 â€” squaring (incl ending-in-5)
  ['div'],                          // 11 â€” division
  ['fracdec','pct'],                // 12 â€” fraction/decimal compare & conversion
  ['conv','roman'],                 // 13 â€” conversions (roman, units)
  ['conv','roman'],                 // 14 â€” conversions
  ['lcm','gcd'],                    // 15 â€” GCD / LCM
  ['pct'],                          // 16 â€” percent problems
  ['mean'],                         // 17 â€” mean / median
  ['series'],                       // 18 â€” sums of integers
  ['rem'],                          // 19 â€” remainder problems
  ['rem','powers','fib','polygon','special'], // 20 â€” number theory
];

// Problems 21-40
const SEQ_21_40 = [
  ['powers'],                       // 21 â€” powers of numbers
  ['powers'],                       // 22
  ['subst'],                        // 23 â€” substitution
  ['subst'],                        // 24
  ['absval'],                       // 25 â€” absolute value
  ['ratio'],                        // 26 â€” ratio / proportion
  ['ratio'],                        // 27
  ['sqrtcube'],                     // 28 â€” square roots / cube roots
  ['sqrtcube'],                     // 29
  ['sets'],                         // 30 â€” sets
  ['base'],                         // 31 â€” base conversion
  ['base'],                         // 32
  ['equations'],                    // 33 â€” solving equations
  ['equations'],                    // 34
  ['repdec'],                       // 35 â€” repeating decimals â†’ fractions
  ['repdec'],                       // 36
  ['areaperi'],                     // 37 â€” perimeter & area
  ['areaperi'],                     // 38
  ['sequences'],                    // 39 â€” sequences
  ['sequences'],                    // 40
];

// Problems 41-60
const SEQ_41_60 = [
  ['exponents'],                    // 41 â€” laws of exponents
  ['exponents'],                    // 42
  ['triangle'],                     // 43 â€” right triangle problems
  ['triangle'],                     // 44
  ['coordgeo'],                     // 45 â€” coordinate geometry
  ['coordgeo'],                     // 46
  ['variation'],                    // 47 â€” direct / inverse variation
  ['variation'],                    // 48
  ['binomial'],                     // 49 â€” sequences & series (finite/infinite)
  ['complex'],                      // 50 â€” complex numbers
  ['complex'],                      // 51
  ['logs'],                         // 52 â€” logarithms
  ['logs'],                         // 53
  ['factperm'],                     // 54 â€” factorials / perms / combs
  ['factperm'],                     // 55
  ['probability'],                  // 56 â€” probability / odds
  ['probability'],                  // 57
  ['binomial'],                     // 58 â€” binomial theorem
  ['binomial'],                     // 59
  ['exponents','logs','factperm'],  // 60 â€” roots of equations / mixed
];

// Problems 61-70
const SEQ_61_70 = [
  ['volume'],                       // 61 â€” volume & surface area
  ['volume'],                       // 62
  ['trig'],                         // 63 â€” trigonometry
  ['trig'],                         // 64
  ['compfunc'],                     // 65 â€” composite functions
  ['compfunc'],                     // 66
  ['volume','trig'],                // 67 â€” mixed tier 4
  ['trig','compfunc'],              // 68
  ['volume','compfunc'],            // 69
  ['trig','volume','compfunc'],     // 70
];

// Problems 71-80
const SEQ_71_80 = [
  ['calculus'],                     // 71 â€” limits
  ['calculus'],                     // 72 â€” derivatives
  ['calculus'],                     // 73
  ['asymptote'],                    // 74 â€” asymptotes
  ['asymptote'],                    // 75
  ['maxmin'],                       // 76 â€” max / min problems
  ['maxmin'],                       // 77
  ['calculus'],                     // 78 â€” definite integration
  ['calculus','maxmin'],            // 79 â€” mixed calculus
  ['calculus','asymptote','maxmin'], // 80
];

// â”€â”€â”€ Sequenced test builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSequencedTest(){
  let probs=[];

  // 1-20: tier 1 â€” prefer real problems of matching type, fall back to generator
  let realByType={};
  REAL_BASIC.forEach(p=>{ if(!realByType[p.t]) realByType[p.t]=[]; realByType[p.t].push(p); });
  Object.keys(realByType).forEach(t=>{ realByType[t]=shuffle(realByType[t]); });
  let usedReal={};

  SEQ_1_20.forEach((slot,i)=>{
    // Problem 10 and 20: use approximation generators
    if(i===9){
      probs.push({...APPROX.tier1(),num:10});
      return;
    }
    if(i===19){
      probs.push({...APPROX.tier1hard(),num:20});
      return;
    }
    
    let realP=null;
    for(let key of shuffle([...slot])){
      let pool=realByType[key]||[], idx=usedReal[key]||0;
      if(idx<pool.length){ realP=pool[idx]; usedReal[key]=idx+1; break; }
    }
    probs.push(realP ? {...realP,num:i+1} : {...GEN[pick(slot)](),num:i+1});
  });

  // 21-40: tier 2 â€” problem 30 and 40 are approximations
  SEQ_21_40.forEach((slot,i)=>{ 
    if(i===9){
      probs.push({...APPROX.tier2(),num:30});
    } else if(i===19){
      probs.push({...APPROX.advanced(),num:40});
    } else {
      probs.push({...GEN2[pick(slot)](),num:i+21}); 
    }
  });
  
  // 41-60: tier 3 â€” problem 50 and 60 are approximations
  SEQ_41_60.forEach((slot,i)=>{ 
    if(i===9 || i===19){
      probs.push({...APPROX.advanced(),num:i+41});
    } else {
      probs.push({...GEN3[pick(slot)](),num:i+41}); 
    }
  });
  
  // 61-70: tier 4 â€” problem 70 is approximation
  SEQ_61_70.forEach((slot,i)=>{ 
    if(i===9){
      probs.push({...APPROX.advanced(),num:70});
    } else {
      probs.push({...GEN4[pick(slot)](),num:i+61}); 
    }
  });
  
  // 71-80: tier 5 â€” problem 80 is approximation
  SEQ_71_80.forEach((slot,i)=>{ 
    if(i===9){
      probs.push({...APPROX.advanced(),num:80});
    } else {
      probs.push({...GEN5[pick(slot)](),num:i+71}); 
    }
  });

  return probs;
}

// â”€â”€â”€ Timed round builder (20 problems, sequenced like the real 1-20) â”€â”€â”€â”€â”€â”€â”€
function buildTimedRound(count){
  let realByType={};
  REAL_BASIC.forEach(p=>{ if(!realByType[p.t]) realByType[p.t]=[]; realByType[p.t].push(p); });
  Object.keys(realByType).forEach(t=>{ realByType[t]=shuffle(realByType[t]); });
  let usedReal={};

  return SEQ_1_20.slice(0,count).map((slot,i)=>{
    // Insert starred problems at positions 10 and 20
    if(i===9 && count>=10){
      return {...APPROX.tier1(),num:10};
    }
    if(i===19 && count>=20){
      return {...APPROX.tier1hard(),num:20};
    }
    
    let realP=null;
    for(let key of shuffle([...slot])){
      let pool=realByType[key]||[], idx=usedReal[key]||0;
      if(idx<pool.length){ realP=pool[idx]; usedReal[key]=idx+1; break; }
    }
    return realP ? {...realP,num:i+1} : {...GEN[pick(slot)](),num:i+1};
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  screen:'menu',        // menu | test | results | stats
  problems:[],
  idx:0,
  answer:'',
  score:0,
  timeLeft:0,
  timed:true,           // false = drill (no timer)\n  answered:[],
  mode:'',              // timed20 | drill | topic | full
  topicKey:null,
  timer:null,
  feedback:'',          // '' | 'correct' | 'wrong'
  feedbackText:'',
  startTime:0,          // Track when test started for speed stats
  streak:0,
  drillCount:0
};
function setState(p){Object.assign(state,p);render();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTimer(){
  if(state.timer) clearInterval(state.timer);
  state.timer=setInterval(()=>{
    state.timeLeft--;
    let el=document.querySelector('.t-timer');
    if(el){
      el.textContent='â± '+fmtT(state.timeLeft);
      el.className='t-timer '+(state.timeLeft<30?'urgent':state.timeLeft<60?'warn':'ok');
    }
    if(state.timeLeft<=0){clearInterval(state.timer);state.timer=null;endTest();}
  },1000);
}
function stopTimer(){if(state.timer){clearInterval(state.timer);state.timer=null;}}
function fmtT(s){return Math.floor(s/60)+':'+(s%60).toString().padStart(2,'0');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START MODES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTimed(secs){
  stopTimer();
  let probs=buildTimedRound(20);
  setState({screen:'test',problems:probs,idx:0,answer:'',score:0,timeLeft:secs,timed:true,answered:[],mode:'timed20',timedSecs:secs,feedback:'',feedbackText:'',streak:0,drillCount:0,startTime:Date.now()});
  setTimeout(()=>{startTimer();focusInput();},50);
}
function startDrill(){
  stopTimer();
  let probs=buildBasicPool(40,null).map((p,i)=>({...p,num:i+1}));
  setState({screen:'test',problems:probs,idx:0,answer:'',score:0,timeLeft:0,timed:false,answered:[],mode:'drill',feedback:'',feedbackText:'',streak:0,drillCount:0,startTime:Date.now()});
  setTimeout(focusInput,50);
}
function startTopicDrill(key){
  stopTimer();
  let probs=buildBasicPool(40,key).map((p,i)=>({...p,num:i+1}));
  setState({screen:'test',problems:probs,idx:0,answer:'',score:0,timeLeft:0,timed:false,answered:[],mode:'topic',topicKey:key,feedback:'',feedbackText:'',streak:0,drillCount:0,startTime:Date.now()});
  setTimeout(focusInput,50);
}
function startFullTest(){
  stopTimer();
  let probs=buildSequencedTest();
  setState({screen:'test',problems:probs,idx:0,answer:'',score:0,timeLeft:600,timed:true,answered:[],mode:'full',feedback:'',feedbackText:'',streak:0,drillCount:0,startTime:Date.now()});
  setTimeout(()=>{startTimer();focusInput();},50);
}
function focusInput(){let e=document.getElementById('ans-input');if(e)e.focus();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT / SKIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function normAns(s){
  // Normalize user or expected answer string for comparison
  s = String(s).trim().replace(/\s/g,'').toLowerCase();
  s = s.replace(/[âˆ’â€“]/g,'-'); // unify minus signs
  return s;
}
function answerMatches(userRaw, expected, starred){
  let u = normAns(userRaw);
  let e = normAns(expected);

  // Exact string match (handles fractions, trig, complex)
  if(u === e) return true;

  // If expected is a string fraction like "3/4", try parsing both as floats
  if(typeof expected === 'string' && expected.includes('/')){
    let parts = e.split('/');
    if(parts.length===2){
      let eVal = parseFloat(parts[0])/parseFloat(parts[1]);
      let uVal = parseFloat(u);
      if(!isNaN(eVal) && !isNaN(uVal) && Math.abs(uVal-eVal)<0.001) return true;
    }
  }

  // Numeric comparison
  let uNum = parseFloat(u);
  let eNum = typeof expected==='number' ? expected : parseFloat(e);
  if(!isNaN(uNum) && !isNaN(eNum)){
    if(starred && eNum!==0){
      return Math.abs(uNum-eNum) <= Math.abs(eNum)*0.05;
    }
    return Math.abs(uNum-eNum) < 0.0001;
  }

  return false;
}

function submitAnswer(){
  let val=state.answer.trim();
  if(val==='') return;
  let cur=state.problems[state.idx];

  let correct = answerMatches(val, cur.a, cur.starred);
  let userAns = val;

  let rec={q:cur.q,a:cur.a,userAns,correct,num:cur.num,hint:cur.hint||null,t:cur.t||null};
  let newAnswered=[...state.answered,rec];
  let newScore=state.score+(correct?1:0);
  let newStreak=correct?(state.streak+1):0;
  let newDrill=state.drillCount+1;
  let newIdx=state.idx+1;

  // DRILL / TOPIC: instant feedback, refill if running low
  if(state.mode==='drill'||state.mode==='topic'){
    let newProbs=[...state.problems];
    if(newIdx>newProbs.length-8){
      let key=state.mode==='topic'?state.topicKey:null;
      newProbs.push(...buildBasicPool(30,key).map((p,i)=>({...p,num:newProbs.length+i+1})));
    }
    let fbText=correct?'âœ“ Correct!':'âœ— Wrong â€” answer: '+cur.a;
    if(!correct && cur.hint) fbText+=' | ğŸ’¡ '+cur.hint;
    setState({
      problems:newProbs, idx:newIdx, answer:'', answered:newAnswered,
      score:newScore, streak:newStreak, drillCount:newDrill,
      feedback:correct?'correct':'wrong',
      feedbackText:fbText
    });
    setTimeout(focusInput,60);
    return;
  }

  // TIMED / FULL: advance or end
  if(newIdx>=state.problems.length){
    state.answered=newAnswered; state.score=newScore; endTest();
  } else {
    setState({idx:newIdx,answer:'',answered:newAnswered,score:newScore,streak:newStreak,feedback:'',feedbackText:''});
    setTimeout(focusInput,30);
  }
}

function skipProblem(){
  let cur=state.problems[state.idx];
  let rec={q:cur.q,a:cur.a,userAns:null,correct:false,num:cur.num,hint:cur.hint||null,t:cur.t||null};
  let newAnswered=[...state.answered,rec];
  let newIdx=state.idx+1;
  let newDrill=state.drillCount+1;

  if(state.mode==='drill'||state.mode==='topic'){
    let newProbs=[...state.problems];
    if(newIdx>newProbs.length-8){
      let key=state.mode==='topic'?state.topicKey:null;
      newProbs.push(...buildBasicPool(30,key).map((p,i)=>({...p,num:newProbs.length+i+1})));
    }
    setState({
      problems:newProbs, idx:newIdx, answer:'', answered:newAnswered,
      streak:0, drillCount:newDrill,
      feedback:'wrong', feedbackText:'â­ Skipped â€” answer: '+cur.a
    });
    setTimeout(focusInput,60);
    return;
  }

  if(newIdx>=state.problems.length){
    state.answered=newAnswered; endTest();
  } else {
    setState({idx:newIdx,answer:'',answered:newAnswered,streak:0,feedback:'',feedbackText:''});
    setTimeout(focusInput,30);
  }
}

function endTest(){
  stopTimer();
  
  // Record session stats
  let timeUsed = state.startTime ? Math.round((Date.now() - state.startTime) / 1000) : 0;
  let topicBreakdown = getTopicBreakdown(state.answered);
  
  recordSession({
    mode: state.mode,
    score: state.score,
    total: state.answered.length,
    timeUsed: timeUsed,
    topicBreakdown: topicBreakdown
  });
  
  setState({screen:'results'});
}
function goMenu(){stopTimer();setState({screen:'menu',problems:[],idx:0,answer:'',score:0,timeLeft:0,answered:[],feedback:'',feedbackText:'',streak:0,drillCount:0});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOLUTION HINTS (detailed walkthroughs for learning)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSolutionHint(q,ans,topic){
  // Provide step-by-step explanation based on problem type and question
  if(!topic) return "Review the problem and try breaking it into smaller steps.";
  
  // ENHANCED ARITHMETIC STRATEGIES - parse the actual numbers from the question
  if(topic==='add' || topic==='sub' || topic==='mul' || topic==='div' || topic==='ops'){
    return getArithmeticStrategy(q, ans, topic);
  }
  
  // Multiplication tricks
  if(topic==='mul11') return "To multiply by 11: add the digits and insert between them. If sum â‰¥10, carry the 1.";
  if(topic==='mul25') return "To multiply by 25: divide by 4, then multiply by 100. (Since 25 = 100/4)";
  if(topic==='near100') return "Use (100-a)(100-b) = 10000 - 100a - 100b + ab. Example: 97Ã—98 = 10000-300-200+6 = 9506.";
  
  // Squaring tricks
  if(topic==='sq5' || topic==='sq'){
    return getSquaringStrategy(q, ans);
  }
  
  // Cubing tricks
  if(topic==='cube'){
    let nums = q.match(/\d+/g);
    if(nums && nums.length > 0){
      let n = parseInt(nums[0]);
      if(n <= 10){
        return `<strong>Memorize small cubes:</strong> 1Â³=1, 2Â³=8, 3Â³=27, 4Â³=64, 5Â³=125, 6Â³=216, 7Â³=343, 8Â³=512, 9Â³=729, 10Â³=1000.`;
      }
      if(n >= 10 && n <= 20){
        let tens = Math.floor(n/10) * 10;
        let ones = n % 10;
        return `<strong>Expand (a+b)Â³:</strong> ${n}Â³ = (${tens}+${ones})Â³ = ${tens}Â³ + 3(${tens}Â²Ã—${ones}) + 3(${tens}Ã—${ones}Â²) + ${ones}Â³. Calculate each term and add.`;
      }
    }
    return "Memorize cubes 1Â³ through 10Â³. For larger numbers, use (a+b)Â³ = aÂ³ + 3aÂ²b + 3abÂ² + bÂ³.";
  }
  
  // Series and sequences
  if(topic==='series'){
    if(q.includes('1 + 2')) return "Triangular numbers: sum = n(n+1)/2. Example: 1+2+...+10 = 10Ã—11/2 = 55.";
    if(q.includes('consecutive')) return "Sum of consecutive integers = (first+last)Ã—count/2.";
    return "Look for patterns: arithmetic (constant difference) or geometric (constant ratio).";
  }
  
  // Fractions and decimals
  if(topic==='fracdec'){
    if(q.includes('%')) return "Convert percent to fraction: divide by 100 and simplify. Example: 25% = 25/100 = 1/4.";
    return "To convert fraction to decimal: divide numerator by denominator.";
  }
  
  // Powers
  if(topic==='powers') return "Memorize common powers: 2Â¹â°=1024, 3âµ=243, 5â´=625. Use exponent laws: aáµÃ—aâ¿ = aáµâºâ¿, (aáµ)â¿ = aáµâ¿.";
  
  // Remainders
  if(topic==='rem') return "To find remainder of aÃ·b: compute a mod b, or subtract multiples of b from a until result <b.";
  
  // LCM/GCD
  if(topic==='lcm'||topic==='gcd'){
    if(topic==='lcm') return "LCM = (aÃ—b)/GCD(a,b). Or list multiples until you find the first common one.";
    return "GCD: use Euclidean algorithm or factor both numbers and take common factors.";
  }
  
  // Percentages
  if(topic==='pct') return "For percent problems: 'is/of = %/100'. Cross-multiply to solve.";
  
  // Mean/median/mode
  if(topic==='mean') return "Mean = sumÃ·count. Median = middle value (sort first). Mode = most frequent value.";
  
  // Geometry
  if(topic==='areaperi') return "Rectangle: A=lw, P=2(l+w). Triangle: A=Â½bh. Circle: A=Ï€rÂ², C=2Ï€r.";
  if(topic==='coordgeo'){
    if(q.includes('Distance')) return "Distance = âˆš[(xâ‚‚-xâ‚)Â²+(yâ‚‚-yâ‚)Â²]. Memorize Pythagorean triples: 3-4-5, 5-12-13, 8-15-17.";
    if(q.includes('Slope')) return "Slope = (yâ‚‚-yâ‚)/(xâ‚‚-xâ‚). Rise over run.";
    if(q.includes('Midpoint')) return "Midpoint = ((xâ‚+xâ‚‚)/2, (yâ‚+yâ‚‚)/2). Average the coordinates.";
  }
  if(topic==='triangle') return "Pythagorean theorem: aÂ²+bÂ²=cÂ². Memorize common triples.";
  if(topic==='volume') return "Cube: V=sÂ³. Box: V=lwh. Sphere: V=4Ï€rÂ³/3. Cylinder: V=Ï€rÂ²h.";
  
  // Algebra
  if(topic==='equations') return "Isolate the variable: use inverse operations. Example: 2x+5=13 â†’ 2x=8 â†’ x=4.";
  if(topic==='absval') return "Absolute value |x| is distance from zero. Always non-negative. |a-b| = distance between a and b.";
  
  // Advanced
  if(topic==='complex') return "iÂ²=-1, iÂ³=-i, iâ´=1 (cycle repeats). |a+bi| = âˆš(aÂ²+bÂ²).";
  if(topic==='logs') return "logâ‚(x) asks: 'a to what power = x?'. log(xy) = log(x)+log(y).";
  if(topic==='trig') return "Right triangle: sin=opp/hyp, cos=adj/hyp, tan=opp/adj. Memorize for 30-60-90 and 45-45-90 triangles.";
  if(topic==='probability') return "P(event) = favorable/total. For dice: 36 total outcomes. For cards: 52 total.";
  
  // Calculus
  if(topic==='calculus') return "Derivative: power rule d/dx(xâ¿) = nxâ¿â»Â¹. Limit: substitute x value if no division by zero.";
  
  return "Break the problem into steps. Check your arithmetic carefully.";
}

// New helper function for detailed arithmetic strategies
function getArithmeticStrategy(q, ans, topic){
  // Extract numbers from the question
  let nums = q.match(/-?\d+/g);
  if(!nums || nums.length < 2) return "Work through the calculation step by step.";
  
  let a = parseInt(nums[0]);
  let b = parseInt(nums[1]);
  
  // ADDITION strategies
  if(topic === 'add'){
    if(b >= 90 && b <= 99){
      return `Add to nearest 100, then adjust: ${a} + ${b} = ${a} + 100 âˆ’ ${100-b} = ${a+100} âˆ’ ${100-b} = ${ans}.`;
    }
    if(a % 10 + b % 10 === 10){
      return `Friendly numbers (add to 10): ${a} + ${b} = ${Math.floor(a/10)*10} + ${Math.floor(b/10)*10} + 10 = ${ans}.`;
    }
    if(b <= 10){
      return `Count up: ${a} + ${b} = ${a} â†’ ${a+1} â†’ ... â†’ ${ans}.`;
    }
    return `Break into parts: ${a} + ${b} = ${a} + ${Math.floor(b/10)*10} + ${b%10} = ${a+Math.floor(b/10)*10} + ${b%10} = ${ans}.`;
  }
  
  // SUBTRACTION strategies
  if(topic === 'sub'){
    if(b >= 90 && b <= 99){
      return `Subtract 100, then add back: ${a} âˆ’ ${b} = ${a} âˆ’ 100 + ${100-b} = ${a-100} + ${100-b} = ${ans}.`;
    }
    if(a % 10 < b % 10){
      return `Borrow from tens: ${a} = ${Math.floor(a/10)*10} + ${a%10} â†’ ${Math.floor(a/10)*10-10} + ${10+a%10}. Now ${10+a%10} âˆ’ ${b%10} = ${10+a%10-b%10}, plus ${Math.floor(a/10)*10-10-Math.floor(b/10)*10} = ${ans}.`;
    }
    return `Count down or use place value: ${a} âˆ’ ${b} = ${a} âˆ’ ${Math.floor(b/10)*10} âˆ’ ${b%10} = ${a-Math.floor(b/10)*10} âˆ’ ${b%10} = ${ans}.`;
  }
  
  // MULTIPLICATION strategies
  if(topic === 'mul'){
    // Check for special patterns
    if(b === 11){
      return `Ã—11 trick: ${a} Ã— 11 â†’ add digits ${Math.floor(a/10)} + ${a%10} = ${Math.floor(a/10)+a%10}, insert between â†’ ${ans}. (If sum â‰¥10, carry the 1)`;
    }
    if(b === 25){
      return `Ã—25 shortcut: ${a} Ã— 25 = ${a} Ã· 4 Ã— 100 = ${a/4} Ã— 100 = ${ans}.`;
    }
    if(a >= 90 || b >= 90){
      let nearA = a >= 90 ? 100 - a : 0;
      let nearB = b >= 90 ? 100 - b : 0;
      if(nearA && nearB){
        return `Near 100: (100âˆ’${nearA})(100âˆ’${nearB}) = 10000 âˆ’ ${nearA}00 âˆ’ ${nearB}00 + ${nearA*nearB} = ${ans}.`;
      }
    }
    if(b <= 12){
      return `Break into parts: ${a} Ã— ${b} = ${a} Ã— ${Math.floor(b/2)*2} + ${a} Ã— ${b%2} = ${a*Math.floor(b/2)*2} + ${a*(b%2)} = ${ans}.`;
    }
    // Distributive property
    let tens = Math.floor(b/10) * 10;
    let ones = b % 10;
    return `Use distributive: ${a} Ã— ${b} = ${a} Ã— (${tens} + ${ones}) = ${a*tens} + ${a*ones} = ${ans}.`;
  }
  
  // DIVISION strategies
  if(topic === 'div'){
    if(a % b === 0){
      // Check for patterns
      if(b <= 12){
        return `Know your division facts: ${a} Ã· ${b} = ${ans}. Practice multiples of ${b}: ${b}, ${b*2}, ${b*3}...`;
      }
      return `Factor and simplify: ${a} Ã· ${b} = ${ans}. Check: ${ans} Ã— ${b} = ${a}.`;
    }
    return `Long division or factor: Work step-by-step to get ${ans}. Verify: ${ans} Ã— ${b} â‰ˆ ${a}.`;
  }
  
  // ORDER OF OPERATIONS (mixed)
  if(topic === 'ops'){
    return `Follow PEMDAS: <strong>1)</strong> Parentheses, <strong>2)</strong> Exponents, <strong>3)</strong> Multiply/Divide (leftâ†’right), <strong>4)</strong> Add/Subtract (leftâ†’right). Work through each step carefully.`;
  }
  
  return "Work through the problem step-by-step using mental math strategies.";
}

// Helper function for squaring strategies
function getSquaringStrategy(q, ans){
  let nums = q.match(/\d+/g);
  if(!nums || nums.length < 1) return "Memorize perfect squares or use (a+b)(a-b) patterns.";
  
  let n = parseInt(nums[0]);
  
  // Numbers ending in 5 - special trick
  if(n % 10 === 5){
    let tens = Math.floor(n/10);
    return `<strong>Ã—5 ending trick:</strong> ${n}Â² â†’ ${tens} Ã— ${tens+1} = ${tens*(tens+1)}, then append 25 â†’ <strong>${tens*(tens+1)}25</strong> = ${ans}.`;
  }
  
  // Numbers near a multiple of 10
  if(n % 10 === 1 || n % 10 === 9){
    let base = Math.round(n/10) * 10;
    let diff = n - base;
    if(diff > 0){
      return `<strong>Near ${base}:</strong> ${n}Â² = (${base}+${diff})Â² = ${base}Â² + 2(${base}Ã—${diff}) + ${diff}Â² = ${base*base} + ${2*base*diff} + ${diff*diff} = ${ans}.`;
    } else {
      let posDiff = Math.abs(diff);
      return `<strong>Near ${base}:</strong> ${n}Â² = (${base}âˆ’${posDiff})Â² = ${base}Â² âˆ’ 2(${base}Ã—${posDiff}) + ${posDiff}Â² = ${base*base} âˆ’ ${2*base*posDiff} + ${posDiff*posDiff} = ${ans}.`;
    }
  }
  
  // Numbers near 50
  if(n >= 45 && n <= 55 && n % 10 !== 5){
    let diff = n - 50;
    if(diff > 0){
      return `<strong>Near 50:</strong> ${n}Â² = (50+${diff})Â² = 2500 + 2(50Ã—${diff}) + ${diff}Â² = 2500 + ${100*diff} + ${diff*diff} = ${ans}.`;
    } else {
      let posDiff = Math.abs(diff);
      return `<strong>Near 50:</strong> ${n}Â² = (50âˆ’${posDiff})Â² = 2500 âˆ’ ${100*posDiff} + ${posDiff*posDiff} = ${ans}.`;
    }
  }
  
  // Difference of squares pattern for numbers near each other
  // Example: 63Â² = (60+3)(60+3) or use 63Â² = 60Â² + 2(60Ã—3) + 3Â²
  if(n >= 20 && n <= 99){
    let tens = Math.floor(n/10) * 10;
    let ones = n % 10;
    return `<strong>Expand (a+b)Â²:</strong> ${n}Â² = (${tens}+${ones})Â² = ${tens}Â² + 2(${tens}Ã—${ones}) + ${ones}Â² = ${tens*tens} + ${2*tens*ones} + ${ones*ones} = ${ans}.<br>Or memorize: common squares like 60Â²=3600, then adjust.`;
  }
  
  // Small numbers - just memorize
  if(n <= 20){
    return `<strong>Memorize small squares:</strong> 1Â²=1, 2Â²=4, 3Â²=9, 4Â²=16, 5Â²=25, 6Â²=36, 7Â²=49, 8Â²=64, 9Â²=81, 10Â²=100, 11Â²=121, 12Â²=144, 15Â²=225, 20Â²=400. Know them cold!`;
  }
  
  return `Use (a+b)Â² = aÂ² + 2ab + bÂ² pattern, or break into ${Math.floor(n/10)*10} + ${n%10}.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  document.getElementById('app').innerHTML =
    state.screen==='menu'  ? renderMenu() :
    state.screen==='test'  ? renderTest() :
    state.screen==='stats' ? renderStats() :
    renderResults();
  attachListeners();
}
function renderMenu(){
  const CORE_KEYS=['add','sub','mul','div','sq','cube','rem','lcm','pct','conv','roman','mean'];
  const TRICK_KEYS=['mul11','mul25','near100','sq5','special','series','fracdec','powers','fib','polygon'];
  
  // Get quick stats preview
  let stats = getStats();
  let statsPreview = stats.totalSessions > 0 ? 
    `<div class="stats-preview">
      <div class="sp-item">ğŸ“Š ${stats.totalSessions} session${stats.totalSessions>1?'s':''}</div>
      <div class="sp-item">ğŸ¯ ${stats.overallAccuracy}% accuracy</div>
      ${stats.streak > 0 ? `<div class="sp-item">ğŸ”¥ ${stats.streak} day streak!</div>` : ''}
      ${stats.bestScore.score > 0 ? `<div class="sp-item">ğŸ† Best: ${stats.bestScore.score}/20</div>` : ''}
    </div>` : '';

  function topicBtns(keys){
    return keys.map(k=>{
      let t=TOPICS[k];
      let realCt=REAL_BASIC.filter(p=>p.t===k||(k==='lcm'&&p.t==='gcd')).length;
      return `<button class="topic-btn" data-topic="${k}">
        <div class="tb-icon">${t.icon}</div>
        <div class="tb-name">${t.name}</div>
        <div class="tb-sub">${realCt>0?realCt+' real probs':'Generator'}</div>
      </button>`;
    }).join('');
  }

  return `
  <div class="header">
    <h1>UIL Number Sense Trainer</h1>
    <p>Master mental math for UIL competition</p>
    ${statsPreview}
    <button class="stats-btn" id="btn-stats">ğŸ“ˆ View Progress & Stats</button>
  </div>
  <div class="menu-body">

    <div class="section-tag">â­ Problems 1â€“20 Focus</div>
    <div class="focus-card">
      <div class="fc-head">
        <div class="fc-icon">ğŸ¯</div>
        <div>
          <h2>Problems 1â€“20 Training</h2>
          <p>On a real UIL test these 20 problems should take about 2.5 minutes if you're sharp â€” that's your foundation score. Practice here until you can crush them consistently.</p>
        </div>
      </div>
      <div class="mode-row">
        <button class="mode-btn" id="btn-timed-open">
          <div class="mb-title">â±ï¸ Timed Round</div>
          <div class="mb-desc">Pick your time â€” 2:30 up to 10:00</div>
        </button>
        <button class="mode-btn" id="btn-drill">
          <div class="mb-title">ğŸ”¥ Drill Mode</div>
          <div class="mb-desc">Infinite problems, no timer. Instant feedback â€” build your speed.</div>
        </button>
      </div>
    </div>

    <div class="section-tag">ğŸ“Š Core Skills</div>
    <div class="topic-grid">${topicBtns(CORE_KEYS)}</div>

    <div class="section-tag">ğŸ§  Trick Drills â€” Shortcuts from the Heath Manual</div>
    <div class="topic-grid">${topicBtns(TRICK_KEYS)}</div>

    <div class="section-tag">ğŸ† Full Test</div>
    <div class="sec-row">
      <button class="sec-btn" id="btn-full">
        <div class="sb-title">ğŸ† Full 80-Problem Simulation</div>
        <div class="sb-desc">All difficulty levels, 10 minutes â€” complete UIL format</div>
      </button>
    </div>
  </div>

  <!-- TIME PICKER MODAL (hidden until btn-timed-open clicked) -->
  <div class="modal-overlay" id="time-modal" style="display:none;">
    <div class="modal-box">
      <h2>â±ï¸ Pick Your Time</h2>
      <p class="modal-sub">All rounds use the same Problems 1â€“20 pool. Choose how long you want to work through them.</p>
      <button class="time-btn" data-secs="150">
        <div class="tb-row"><span class="tb-time">2 : 30</span><span class="tb-note">Real UIL pacing for 1â€“20</span></div>
      </button>
      <button class="time-btn" data-secs="300">
        <div class="tb-row"><span class="tb-time">5 : 00</span><span class="tb-note">Comfortable warm-up pace</span></div>
      </button>
      <button class="time-btn" data-secs="450">
        <div class="tb-row"><span class="tb-time">7 : 30</span><span class="tb-note">Relaxed practice</span></div>
      </button>
      <button class="time-btn" data-secs="600">
        <div class="tb-row"><span class="tb-time">10 : 00</span><span class="tb-note">Full UIL test length</span></div>
      </button>
      <button class="modal-close" id="btn-time-close">âœ• Close</button>
    </div>
  </div>

  <!-- QUICK REFERENCE FAB + MODAL -->
  <button class="ref-fab" id="btn-ref-open" title="Quick Reference">ğŸ“–</button>
  <div class="ref-modal" id="ref-modal">
    <div class="ref-content">
      <h2>ğŸ“š Quick Reference Guide</h2>
      
      <h3>ğŸš€ Mental Math Shortcuts</h3>
      <div class="ref-grid">
        <div class="ref-card">
          <h4>Squaring (Ã·5)</h4>
          <p>45Â² â†’ 4Ã—5=20, then 2025<br>65Â² â†’ 6Ã—7=42, then 4225<br>Pattern: n(n+1) then 25</p>
        </div>
        <div class="ref-card">
          <h4>Ã—11 Trick</h4>
          <p>34Ã—11: Add 3+4=7, insert<br>â†’ 3<strong>7</strong>4 = 374<br>67Ã—11: 6+7=13, carry<br>â†’ 737</p>
        </div>
        <div class="ref-card">
          <h4>Ã—25 Shortcut</h4>
          <p>nÃ—25 = nÃ·4 Ã—100<br>48Ã—25: 48Ã·4=12 â†’1200<br>17Ã—25: 17Ã·4=4.25 â†’425</p>
        </div>
        <div class="ref-card">
          <h4>Near 100</h4>
          <p>97Ã—98: (100âˆ’3)(100âˆ’2)<br>= 10000 âˆ’ 200 âˆ’ 300 + 6<br>= 9506</p>
        </div>
      </div>

      <h3>ğŸ“ Essential Formulas</h3>
      <div class="ref-grid">
        <div class="ref-card">
          <h4>Triangular Numbers</h4>
          <p><code>n(n+1)/2</code><br>1+2+3+...+10 = 10Ã—11/2 = 55</p>
        </div>
        <div class="ref-card">
          <h4>Consecutive Integers</h4>
          <p>Sum = (first+last) Ã— count / 2<br>Example: 5+6+...+12<br>= (5+12)Ã—8/2 = 68</p>
        </div>
        <div class="ref-card">
          <h4>Distance Formula</h4>
          <p><code>âˆš[(xâ‚‚âˆ’xâ‚)Â² + (yâ‚‚âˆ’yâ‚)Â²]</code><br>Memorize 3-4-5, 5-12-13, 8-15-17</p>
        </div>
        <div class="ref-card">
          <h4>Quadratic Formula</h4>
          <p><code>x = [âˆ’b Â± âˆš(bÂ²âˆ’4ac)] / 2a</code></p>
        </div>
      </div>

      <h3>ğŸ”¢ Powers & Roots to Memorize</h3>
      <p style="color:#a0aec0; line-height:1.8; margin-top:10px;">
        <strong>Squares:</strong> 1Â²=1, 2Â²=4, ... 20Â²=400, 25Â²=625, 50Â²=2500<br>
        <strong>Cubes:</strong> 1Â³=1, 2Â³=8, 3Â³=27, 4Â³=64, 5Â³=125, 10Â³=1000<br>
        <strong>Powers of 2:</strong> 2Â¹â°=1024, 2Â¹âµ=32768, 2Â²â°=1048576<br>
        <strong>Powers of 3:</strong> 3âµ=243, 3â·=2187, 3Â¹â°=59049
      </p>

      <h3>ğŸ“ Geometry Quick Facts</h3>
      <p style="color:#a0aec0; line-height:1.8; margin-top:10px;">
        Circle: A=Ï€rÂ², C=2Ï€r<br>
        Triangle: A=Â½bh<br>
        Sphere: V=4Ï€rÂ³/3, SA=4Ï€rÂ²<br>
        Cylinder: V=Ï€rÂ²h<br>
        Right triangle: aÂ²+bÂ²=cÂ²
      </p>

      <h3>ğŸ’¡ Test-Taking Tips</h3>
      <ul style="margin-top:10px;">
        <li>Problems 1-20 target: ~2:30 minutes (7.5 sec each)</li>
        <li>Skip if stuck â€” come back with remaining time</li>
        <li>Starred (*) problems accept Â±5% tolerance</li>
        <li>Use scratch paper for long calculations</li>
        <li>Trust your mental math â€” second-guessing wastes time</li>
      </ul>

      <button class="ref-close" id="btn-ref-close">Close</button>
    </div>
  </div>`;
}

function renderTest(){
  let cur=state.problems[state.idx];
  let isDrill=(state.mode==='drill'||state.mode==='topic');
  let total=state.mode==='full'?80:state.mode==='timed20'?20:'âˆ';

  // Mode label
  let label=
    state.mode==='timed20' ? 'â± Timed Round' :
    state.mode==='drill'   ? 'ğŸ”¥ Drill Mode' :
    state.mode==='topic'   ? `ğŸ“Š ${TOPICS[state.topicKey].name}` :
    'ğŸ† Full Test';

  // Timer display
  let timerHTML=state.timed
    ? `<span class="t-timer ok">â± ${fmtT(state.timeLeft)}</span>`
    : `<span class="t-timer none">No timer</span>`;

  // Score / streak
  let scoreHTML=isDrill
    ? `<span class="t-score">âœ“ ${state.score}/${state.drillCount}${state.streak>=3?' <span class="streak">ğŸ”¥ '+state.streak+'</span>':''}</span>`
    : `<span class="t-score">Score: ${state.score} / ${state.idx}</span>`;

  // Progress bar
  let prog=isDrill ? 50 : (state.idx/state.problems.length*100);

  // Feedback (drill only)
  let fbHTML='';
  if(isDrill){
    let fbTxt=state.feedbackText||'&nbsp;';
    // Wrap the hint portion (after "| ğŸ’¡") in a styled span
    if(fbTxt.includes('| ğŸ’¡')){
      let parts=fbTxt.split('| ğŸ’¡');
      fbTxt=parts[0]+'<span class="hint-tag">ğŸ’¡ '+parts[1]+'</span>';
    }
    fbHTML=`<div class="feedback-bar ${state.feedback||'empty'}">${fbTxt}</div>`;
  }

  // Skip button (timed & full only)
  let skipHTML=!isDrill ? `<button class="btn btn-orange" id="btn-skip">Skip</button>` : '';

  return `
  <div class="test-header">
    <div class="test-top">
      <span class="t-label">${label} Â· #${cur.num} of ${total}</span>
      ${timerHTML}
      ${scoreHTML}
    </div>
    <div class="prog-bar"><div class="prog-fill" style="width:${prog}%"></div></div>
  </div>
  <div class="test-body">
    ${fbHTML}
      <div class="problem-text">${cur.q}</div>
    ${cur.starred?'<div class="problem-tag" style="color:#f6ad55;">â˜… Approximation (Â±5% accepted)</div>':''}
    ${typeof cur.a==='string'&&cur.a.includes('/')?'<div class="problem-tag" style="color:#667eea;">Type as a fraction, e.g. 3/4</div>':''}</div>
    <input type="text" class="ans-box" id="ans-input" inputmode="${typeof cur.a==='string'&&cur.a.includes('/')?'text':'decimal'}" value="${state.answer}" placeholder="${typeof cur.a==='string'&&cur.a.includes('/')?'e.g. 3/4':'Your answer'}" autocomplete="off">
    ${typeof cur.a==='string'&&cur.a.includes('/')?`<div class="frac-helper"><button class="frac-btn" id="btn-slash">â„ slash</button></div>`:''}
    <div class="btn-row">
      <button class="btn btn-green" id="btn-submit">Submit</button>
      ${skipHTML}
    </div>
    <button class="btn btn-subtle" id="btn-end">${isDrill?'End Session':'End Test Early'}</button>
  </div>`;
}

function renderResults(){
  let total=state.answered.length;
  let skipped=state.answered.filter(a=>a.userAns===null).length;
  let wrong=total-state.score-skipped;
  let pct=total>0?(state.score/total*100).toFixed(1):0;
  let isDrill=(state.mode==='drill'||state.mode==='topic');

  // Show last 40 in review
  let reviewItems=state.answered.slice(-40).map((item,i)=>{
    let cls=item.correct?'correct':'wrong';
    let ans=item.userAns!==null?item.userAns:'Skipped';
    let extra=!item.correct?` (Ans: ${item.a})`:'';
    let hintHTML=(!item.correct && item.hint)?`<div style="font-size:0.72rem;color:#f6ad55;margin-top:2px;width:100%;">ğŸ’¡ ${item.hint}</div>`:'';
    
    // Add "Show Solution" button for wrong answers
    let solBtn='';
    if(!item.correct){
      let solId=`sol-${i}`;
      solBtn=`<button class="sol-toggle" data-target="${solId}" style="font-size:0.7rem;padding:4px 8px;background:#2d3748;border:1px solid #4a5568;border-radius:6px;color:#667eea;cursor:pointer;margin-top:4px;">How?</button>
      <div id="${solId}" class="solution-box" style="display:none;background:#2d3748;padding:10px;border-radius:6px;margin-top:6px;font-size:0.75rem;line-height:1.6;color:#a0aec0;border-left:3px solid #667eea;">
        <strong style="color:#667eea;">Solution:</strong> ${getSolutionHint(item.q,item.a,item.t)}
      </div>`;
    }
    
    return `<div class="rev-item ${cls}">
      <span class="ri-num">#${item.num}</span>
      <span class="ri-q">${item.q}</span>
      <span class="ri-a">${item.correct?'âœ“':'âœ—'} ${ans}${extra}</span>
      ${hintHTML}
      ${solBtn}
    </div>`;
  }).join('');

  let title=isDrill?'Session Over!':'Test Complete!';

  // Calculate time-based stats for timed modes
  let timeUsed = state.timedSecs ? state.timedSecs - state.timeLeft : 0;
  let secPerProb = total>0 && timeUsed>0 ? (timeUsed/total).toFixed(1) : null;

  // Find weakest topic from wrong answers
  let wrongByTopic={};
  let totalByTopic={};
  state.answered.forEach(item=>{
    let t=item.t||'other';
    totalByTopic[t]=(totalByTopic[t]||0)+1;
    if(!item.correct) wrongByTopic[t]=(wrongByTopic[t]||0)+1;
  });
  let weakest=null;
  Object.keys(wrongByTopic).forEach(t=>{
    if(!weakest || wrongByTopic[t]>wrongByTopic[weakest]) weakest=t;
  });

  let extraStats='';
  if(secPerProb) extraStats+=`<div class="stat-card"><div class="stat-val">${secPerProb}s</div><div class="stat-label">Sec / Problem</div></div>`;
  if(weakest && wrongByTopic[weakest]>=2){
    let topicName=TOPICS[weakest]?TOPICS[weakest].name:weakest;
    extraStats+=`<div class="stat-card" style="border-color:#ed8936;"><div class="stat-val" style="color:#ed8936;font-size:1.1rem;padding-top:6px;">${topicName}</div><div class="stat-label">Needs Work (${wrongByTopic[weakest]} wrong)</div></div>`;
  }
  let retryText=
    state.mode==='timed20' ? `ğŸ” ${fmtT(state.timedSecs||150)} Again` :
    state.mode==='drill'   ? 'ğŸ”¥ Keep Drilling' :
    state.mode==='topic'   ? `ğŸ“Š ${TOPICS[state.topicKey].name} Again` :
    'ğŸ” Full Test Again';

  return `
  <div class="header"><h1 style="font-size:1.9rem;">${title}</h1></div>
  <div class="results-wrap">
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-val">${state.score}</div><div class="stat-label">Correct</div></div>
      <div class="stat-card"><div class="stat-val">${wrong}</div><div class="stat-label">Wrong</div></div>
      <div class="stat-card"><div class="stat-val">${skipped}</div><div class="stat-label">Skipped</div></div>
      <div class="stat-card"><div class="stat-val">${pct}%</div><div class="stat-label">Accuracy</div></div>
      ${extraStats}
    </div>
    <div class="review-title">ğŸ“‹ Answer Review${total>40?' (last 40)':''}</div>
    <div class="review-box">${reviewItems}</div>
    <div class="res-btns">
      <button class="btn btn-primary" id="btn-menu">â† Menu</button>
      <button class="btn btn-dark" id="btn-retry">${retryText}</button>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats(){
  let stats = getStats();
  
  if(stats.totalSessions === 0){
    return `
    <div class="stats-screen">
      <div class="header">
        <h1>ğŸ“ˆ Your Progress</h1>
        <button class="back-btn" id="btn-menu">â† Back</button>
      </div>
      <div class="empty-stats">
        <div class="es-icon">ğŸ“Š</div>
        <h2>No Stats Yet!</h2>
        <p>Complete a practice session to start tracking your progress.</p>
        <button class="btn btn-primary" id="btn-menu">Start Practicing</button>
      </div>
    </div>`;
  }
  
  // Overview cards
  let daysSince = Math.floor((Date.now() - new Date(stats.firstUse).getTime()) / 86400000);
  let improvement = stats.recentAccuracy - (stats.overallAccuracy);
  let improvementHTML = improvement > 0 ? 
    `<div class="stat-badge positive">+${improvement}% recent</div>` :
    improvement < -5 ? `<div class="stat-badge negative">${improvement}% recent</div>` : '';
  
  // Topic breakdown - find strongest and weakest
  let topicList = Object.entries(stats.topicStats)
    .map(([topic, data]) => ({
      topic,
      name: TOPICS[topic]?.name || topic,
      accuracy: data.total > 0 ? Math.round(data.correct / data.total * 100) : 0,
      correct: data.correct,
      total: data.total
    }))
    .filter(t => t.total >= 3) // Only show topics with at least 3 attempts
    .sort((a,b) => b.accuracy - a.accuracy);
  
  let topicHTML = topicList.length > 0 ? topicList.map(t => {
    let barWidth = t.accuracy;
    let barColor = t.accuracy >= 80 ? '#48bb78' : t.accuracy >= 60 ? '#ed8936' : '#f56565';
    return `
    <div class="topic-stat">
      <div class="ts-name">${t.name}</div>
      <div class="ts-bar-container">
        <div class="ts-bar" style="width:${barWidth}%;background:${barColor};"></div>
      </div>
      <div class="ts-score">${t.correct}/${t.total} (${t.accuracy}%)</div>
    </div>`;
  }).join('') : '<p style="color:#718096;">Complete topic drills to see breakdown.</p>';
  
  // Recent sessions graph (last 10)
  let graphData = stats.recentSessions.slice(0,10).reverse();
  let maxScore = Math.max(...graphData.map(s => s.total));
  let graphHTML = graphData.map((s,i) => {
    let height = (s.score / s.total * 100);
    let date = new Date(s.date);
    let label = date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
    let modeLabel = s.mode==='timed20' ? 'T20' : s.mode==='full' ? 'F80' : 'Drill';
    return `
    <div class="graph-bar">
      <div class="gb-bar-container">
        <div class="gb-bar" style="height:${height}%;" title="${s.score}/${s.total}"></div>
      </div>
      <div class="gb-label">${label}</div>
      <div class="gb-mode">${modeLabel}</div>
    </div>`;
  }).join('');
  
  // Session history table
  let historyHTML = stats.recentSessions.slice(0,15).map(s => {
    let date = new Date(s.date);
    let timeStr = date.toLocaleString('en-US', {month:'short', day:'numeric', hour:'numeric', minute:'2-digit'});
    let modeStr = s.mode==='timed20' ? 'Timed 20' : s.mode==='full' ? 'Full Test' : s.mode==='drill' ? 'Drill' : 'Topic';
    let pct = Math.round(s.score/s.total*100);
    let pctColor = pct >= 80 ? '#48bb78' : pct >= 60 ? '#ed8936' : '#f56565';
    let speedStr = s.secondsPerProblem ? `${s.secondsPerProblem}s/prob` : 'â€”';
    return `
    <tr>
      <td>${timeStr}</td>
      <td>${modeStr}</td>
      <td>${s.score}/${s.total}</td>
      <td style="color:${pctColor};font-weight:600;">${pct}%</td>
      <td>${speedStr}</td>
    </tr>`;
  }).join('');
  
  return `
  <div class="stats-screen">
    <div class="header">
      <h1>ğŸ“ˆ Your Progress</h1>
      <button class="back-btn" id="btn-menu">â† Back</button>
    </div>
    
    <div class="stats-body">
      <!-- Overview Cards -->
      <div class="stats-grid">
        <div class="stat-card big">
          <div class="stat-val">${stats.totalSessions}</div>
          <div class="stat-label">Practice Sessions</div>
          <div class="stat-sub">${daysSince} days active</div>
        </div>
        <div class="stat-card big">
          <div class="stat-val">${stats.overallAccuracy}%</div>
          <div class="stat-label">Overall Accuracy</div>
          <div class="stat-sub">${stats.totalCorrect}/${stats.totalProblems} correct</div>
          ${improvementHTML}
        </div>
        ${stats.streak > 0 ? `
        <div class="stat-card big" style="border-color:#ed8936;">
          <div class="stat-val" style="color:#ed8936;">ğŸ”¥ ${stats.streak}</div>
          <div class="stat-label">Day Streak</div>
          <div class="stat-sub">Keep it going!</div>
        </div>` : ''}
        ${stats.speedImprovement && stats.speedImprovement > 0 ? `
        <div class="stat-card big" style="border-color:#48bb78;">
          <div class="stat-val" style="color:#48bb78;">-${stats.speedImprovement}s</div>
          <div class="stat-label">Speed Improvement</div>
          <div class="stat-sub">Per problem (first 10 vs last 10)</div>
        </div>` : ''}
      </div>
      
      <!-- Personal Bests -->
      <h2 style="margin:2rem 0 1rem;">ğŸ† Personal Bests</h2>
      <div class="stats-grid">
        ${stats.bestScore.score > 0 ? `
        <div class="stat-card">
          <div class="stat-val">${stats.bestScore.score}/20</div>
          <div class="stat-label">Best Timed Round</div>
          <div class="stat-sub">${new Date(stats.bestScore.date).toLocaleDateString()}</div>
        </div>` : ''}
        ${stats.bestFullTest.score > 0 ? `
        <div class="stat-card">
          <div class="stat-val">${stats.bestFullTest.score}/80</div>
          <div class="stat-label">Best Full Test</div>
          <div class="stat-sub">${new Date(stats.bestFullTest.date).toLocaleDateString()}</div>
        </div>` : ''}
      </div>
      
      <!-- Performance Graph -->
      <h2 style="margin:2rem 0 1rem;">ğŸ“Š Recent Performance</h2>
      <div class="graph-container">
        ${graphHTML}
      </div>
      
      <!-- Topic Breakdown -->
      <h2 style="margin:2rem 0 1rem;">ğŸ“š Topic Breakdown</h2>
      <div class="topic-stats">
        ${topicHTML}
      </div>
      
      <!-- Session History -->
      <h2 style="margin:2rem 0 1rem;">ğŸ“ Session History</h2>
      <div class="history-table">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Mode</th>
              <th>Score</th>
              <th>Accuracy</th>
              <th>Speed</th>
            </tr>
          </thead>
          <tbody>
            ${historyHTML}
          </tbody>
        </table>
      </div>
      
      <div style="margin-top:2rem;text-align:center;">
        <button class="btn btn-dark" id="btn-clear-stats">ğŸ—‘ï¸ Clear All Stats</button>
      </div>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function attachListeners(){
  let el;
  // Modal open / close
  if(el=document.getElementById('btn-timed-open')) el.onclick=()=>{ document.getElementById('time-modal').style.display='flex'; };
  if(el=document.getElementById('btn-time-close')) el.onclick=()=>{ document.getElementById('time-modal').style.display='none'; };
  if(el=document.getElementById('time-modal')) el.onclick=(e)=>{ if(e.target===el) el.style.display='none'; };
  
  // Reference modal
  if(el=document.getElementById('btn-ref-open')) el.onclick=()=>{ document.getElementById('ref-modal').classList.add('show'); };
  if(el=document.getElementById('btn-ref-close')) el.onclick=()=>{ document.getElementById('ref-modal').classList.remove('show'); };
  if(el=document.getElementById('ref-modal')) el.onclick=(e)=>{ if(e.target===el) el.classList.remove('show'); };
  // Time picker buttons
  document.querySelectorAll('.time-btn').forEach(b=>{
    b.onclick=()=>{ document.getElementById('time-modal').style.display='none'; startTimed(parseInt(b.dataset.secs)); };
  });

  if(el=document.getElementById('btn-drill'))   el.onclick=startDrill;
  if(el=document.getElementById('btn-full'))    el.onclick=startFullTest;

  document.querySelectorAll('.topic-btn').forEach(b=>{
    b.onclick=()=>startTopicDrill(b.dataset.topic);
  });

  if(el=document.getElementById('ans-input')){
    el.oninput=(e)=>{state.answer=e.target.value;};
    el.onkeydown=(e)=>{if(e.key==='Enter') submitAnswer();};
  }
  if(el=document.getElementById('btn-slash')){
    el.onclick=()=>{
      let inp=document.getElementById('ans-input');
      if(!inp) return;
      let start=inp.selectionStart, end=inp.selectionEnd;
      let val=inp.value;
      let newVal=val.slice(0,start)+'/'+val.slice(end);
      inp.value=newVal;
      state.answer=newVal;
      inp.focus();
      inp.setSelectionRange(start+1,start+1);
    };
  }
  if(el=document.getElementById('btn-submit')) el.onclick=submitAnswer;
  if(el=document.getElementById('btn-skip'))   el.onclick=skipProblem;
  if(el=document.getElementById('btn-end'))    el.onclick=endTest;
  if(el=document.getElementById('btn-menu'))   el.onclick=goMenu;
  if(el=document.getElementById('btn-retry'))  el.onclick=()=>{
    if(state.mode==='timed20') startTimed(state.timedSecs||150);
    else if(state.mode==='drill') startDrill();
    else if(state.mode==='topic') startTopicDrill(state.topicKey);
    else startFullTest();
  };
  
  // Stats screen
  if(el=document.getElementById('btn-stats')) el.onclick=()=>{ setState({screen:'stats'}); };
  if(el=document.getElementById('btn-clear-stats')) el.onclick=()=>{
    if(confirm('Are you sure you want to delete all your progress data? This cannot be undone!')){
      localStorage.removeItem('uilNsStats');
      setState({screen:'menu'});
      alert('All stats cleared!');
    }
  };
  
  // Solution toggles in results
  document.querySelectorAll('.sol-toggle').forEach(btn=>{
    btn.onclick=()=>{
      let target=document.getElementById(btn.dataset.target);
      if(target){
        let isHidden=target.style.display==='none';
        target.style.display=isHidden?'block':'none';
        btn.textContent=isHidden?'Hide':'How?';
      }
    };
  });
}

render();
</script>
</body>
</html>
